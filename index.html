<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty - Version Complete</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        
        /* INTERFACE UTILISATEUR (HUD) */
        .ui { position: absolute; inset: 0; pointer-events: none; }
        .panel { 
            position: absolute; 
            background: rgba(0, 15, 30, 0.9); 
            border: 2px solid #00f2ff; 
            padding: 15px; 
            color: white; 
            pointer-events: auto; 
            border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        #stats { top: 15px; left: 15px; display: flex; gap: 25px; font-weight: bold; font-size: 20px; }
        
        #msg { 
            position: absolute; top: 60%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: #00f2ff; font-size: 26px; font-weight: bold; 
            display: none; text-shadow: 0 0 10px #00f2ff; text-align: center; 
            background: rgba(0,0,0,0.7); padding: 20px; border: 1px solid #00f2ff;
        }

        #menu { bottom: 20px; left: 20px; width: 300px; }
        
        .btn { 
            width: 100%; padding: 12px; margin: 6px 0; 
            background: #001a1a; color: #00f2ff; 
            border: 1px solid #00f2ff; cursor: pointer; 
            font-weight: bold; text-transform: uppercase; 
            transition: 0.2s; font-family: 'Courier New', monospace;
        }
        .btn:hover { background: #00f2ff; color: #000; box-shadow: 0 0 15px #00f2ff; }

        /* √âCRAN DE CONNEXION */
        #login-screen { 
            position: absolute; inset: 0; background: #000; z-index: 10000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        input { 
            padding: 15px; width: 250px; background: #111; 
            border: 2px solid #00f2ff; color: white; 
            text-align: center; font-size: 18px; margin-bottom: 20px; outline: none;
        }

        /* LABELS DES ROBOTS */
        .label { 
            position: absolute; color: #ffff00; font-weight: bold; 
            font-size: 12px; transform: translate(-50%, -100%); 
            pointer-events: none; text-shadow: 1px 1px 2px black; 
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00f2ff; font-size: 40px; text-shadow: 0 0 20px #00f2ff;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="NOM DU ROYAUME">
        <button class="btn" style="width: 200px;" onclick="connect()">INITIALISATION</button>
    </div>

    <div id="msg"></div>

    <div class="ui">
        <div id="stats" class="panel">
            <span style="color:#ffd700">üí∞ OR: <span id="gold">0</span></span>
            <span style="color:#8B4513">ü™µ BOIS: <span id="wood">0</span></span>
            <span style="color:#aaa">‚õèÔ∏è MINERAI: <span id="ore">0</span></span>
        </div>
        
        <div id="menu" class="panel">
            <div id="zone-indicator" style="color:#00f2ff; margin-bottom:10px; text-align:center; font-weight:bold; border-bottom:1px solid #00f2ff; padding-bottom:5px;">ZONE : LOBBY</div>
            
            <button class="btn" onclick="buildHouse()">üè† B√ÇTIR (50 BOIS)</button>
            <button class="btn" onclick="addWorker()">ü§ñ ROBOT (150 OR)</button>
            <button class="btn" onclick="goLobby()" style="border-color:#ff4444; color:#ff4444;">üö™ RETOUR LOBBY</button>
        </div>
    </div>

    <div id="labels-container" style="position:absolute; inset:0; pointer-events:none;"></div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
let currentZone = 'lobby'; // √âtats possibles: 'lobby', 'private', 'forest'

// Tableaux pour stocker les objets du jeu
const keys = {};
const trees = [];
const ores = [];
const workers = [];
const visuals = [];
const lobbyHouses = [];

// --- CONNEXION ---
window.connect = () => {
    const p = document.getElementById('pseudo').value;
    if(p) socket.emit('login', { pseudo: p });
};

socket.on('initData', (data) => {
    myStats = data.me;
    document.getElementById('login-screen').style.display = 'none';
    initGame();
});

// --- INITIALISATION DU MOTEUR 3D ---
function initGame() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000510); // Ciel sombre bleut√©
    scene.fog = new THREE.Fog(0x000510, 20, 150);

    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
    
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Lumi√®res
    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(50, 100, 50);
    sun.castShadow = true;
    scene.add(sun);

    // Cr√©ation du Joueur
    player = createChar(0x00f2ff); // Bleu cyan
    scene.add(player);

    // D√©marrage dans le Lobby
    goLobby();
    animate();
}

// --- NETTOYAGE DE LA SC√àNE (Quand on change de zone) ---
function clearZone() {
    visuals.forEach(v => scene.remove(v));
    trees.forEach(t => scene.remove(t));
    ores.forEach(o => scene.remove(o));
    workers.forEach(w => { scene.remove(w.mesh); w.label.remove(); });
    
    visuals.length = 0; 
    trees.length = 0; 
    ores.length = 0; 
    workers.length = 0;
    lobbyHouses.length = 0;
}

// =========================================================
//                   LES 3 ZONES DU JEU
// =========================================================

// 1. LE LOBBY (Centre commun)
window.goLobby = () => {
    currentZone = 'lobby';
    document.getElementById('zone-indicator').innerText = "ZONE : LOBBY COMMUN";
    clearZone();
    player.position.set(0, 0, 30); // Spawn point
    
    // Sol Futuriste
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({color: 0x111111}));
    ground.rotation.x = -Math.PI/2; 
    scene.add(ground); visuals.push(ground);
    
    const grid = new THREE.GridHelper(400, 40, 0x00f2ff, 0x002222);
    scene.add(grid); visuals.push(grid);

    // 8 Maisons en cercle
    for(let i=0; i<8; i++) {
        const angle = (i / 8) * Math.PI * 2;
        const dist = 60;
        const x = Math.cos(angle) * dist;
        const z = Math.sin(angle) * dist;
        
        // Couleur: Verte si c'est la mienne, Grise sinon
        const isMine = (i + 1 === myStats.plotID);
        const color = isMine ? 0x00ff00 : 0x444444;
        
        const houseGroup = new THREE.Group();
        const base = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE.MeshStandardMaterial({color: color}));
        base.position.y = 4;
        houseGroup.add(base);
        
        // Petit toit
        const roof = new THREE.Mesh(new THREE.ConeGeometry(7, 4, 4), new THREE.MeshStandardMaterial({color: 0x222222}));
        roof.position.y = 9; roof.rotation.y = Math.PI/4;
        houseGroup.add(roof);

        houseGroup.position.set(x, 0, z);
        houseGroup.lookAt(0, 0, 0);
        
        scene.add(houseGroup); visuals.push(houseGroup);
        lobbyHouses.push({ mesh: houseGroup, id: i + 1, isMine: isMine });
    }

    // Portail Vert (vers la For√™t)
    const portal = new THREE.Mesh(new THREE.CylinderGeometry(8, 8, 1, 32), new THREE.MeshBasicMaterial({color: 0x00ff00, transparent: true, opacity: 0.4}));
    portal.position.set(0, 0.5, 0);
    scene.add(portal); visuals.push(portal);
    
    // Texte flottant au dessus du portail (simple mesh)
    const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 50, 8), new THREE.MeshBasicMaterial({color: 0x00ff00, transparent: true, opacity: 0.2}));
    beam.position.set(0, 25, 0);
    scene.add(beam); visuals.push(beam);

    // Vendeur Violet (N√©gociant)
    const vendor = createChar(0xaa00ff);
    vendor.position.set(-80, 0, 0);
    vendor.rotation.y = Math.PI/2;
    scene.add(vendor); visuals.push(vendor);
}

// 2. LA ZONE PRIV√âE (Herbe + Mineurs)
function goPrivate() {
    currentZone = 'private';
    document.getElementById('zone-indicator').innerText = "ZONE : TERRAIN PRIV√â";
    clearZone();
    player.position.set(2000, 0, 2000); // Loin dans la map

    // Sol Herbe
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(800, 800), new THREE.MeshStandardMaterial({color: 0x2d5a27}));
    ground.rotation.x = -Math.PI/2; ground.position.set(2000, 0, 2000);
    scene.add(ground); visuals.push(ground);

    // Faire appara√Ætre mes robots
    for(let i=0; i<myStats.workersCount; i++) spawnWorkerIA();
    
    // Faire appara√Ætre du minerai al√©atoire
    for(let i=0; i<40; i++) {
        spawnOre(2000 + (Math.random()*400-200), 2000 + (Math.random()*400-200));
    }
    
    // Faire appara√Ætre mes maisons construites
    myStats.privateHouses.forEach(pos => spawnVisualHouse(pos.x, pos.z));
}

// 3. LA FOR√äT (Arbres)
function goForest() {
    currentZone = 'forest';
    document.getElementById('zone-indicator').innerText = "ZONE : FOR√äT SACR√âE";
    clearZone();
    player.position.set(-2000, 0, -2000); // Loin a l'oppos√©

    // Sol Terre Sombre
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(800, 800), new THREE.MeshStandardMaterial({color: 0x1a3317}));
    ground.rotation.x = -Math.PI/2; ground.position.set(-2000, 0, -2000);
    scene.add(ground); visuals.push(ground);

    // G√©n√©ration d'arbres
    for(let i=0; i<100; i++) {
        spawnTree(-2000 + (Math.random()*500-250), -2000 + (Math.random()*500-250));
    }
}

// =========================================================
//                   CR√âATION D'OBJETS
// =========================================================

function createChar(color) {
    const g = new THREE.Group();
    // Corps
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.2), new THREE.MeshStandardMaterial({color: color}));
    body.position.y = 1; 
    g.add(body);
    return g;
}

function spawnTree(x, z) {
    const t = new THREE.Group();
    // Tronc
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.6, 4), new THREE.MeshStandardMaterial({color: 0x3d2817}));
    trunk.position.y = 2; t.add(trunk);
    // Feuillage
    const leaves = new THREE.Mesh(new THREE.DodecahedronGeometry(2.5), new THREE.MeshStandardMaterial({color: 0x228B22}));
    leaves.position.y = 5; t.add(leaves);
    
    t.position.set(x, 0, z);
    scene.add(t); 
    trees.push(t);
}

function spawnOre(x, z) {
    // Minerai gris brillant
    const o = new THREE.Mesh(new THREE.IcosahedronGeometry(1.2), new THREE.MeshStandardMaterial({color: 0x888888, roughness: 0.2, metalness: 0.8}));
    o.position.set(x, 1, z);
    scene.add(o);
    ores.push(o);
}

function spawnVisualHouse(x, z) {
    const h = new THREE.Mesh(new THREE.BoxGeometry(12, 10, 12), new THREE.MeshStandardMaterial({color: 0xdddddd}));
    h.position.set(x, 5, z);
    scene.add(h); visuals.push(h);
}

function spawnWorkerIA() {
    const w = createChar(0xffff00); // Robot Jaune
    w.position.copy(player.position); 
    scene.add(w);
    
    // Label HTML pour le robot
    const div = document.createElement('div'); div.className = 'label'; 
    document.getElementById('labels-container').appendChild(div);
    
    workers.push({ 
        mesh: w, 
        energy: 100, 
        state: 'find', // √âtats: find (chercher), move (aller), return (revenir)
        home: player.position.clone(), 
        target: null, 
        label: div 
    });
}

// =========================================================
//                   INTERACTIONS & BOUTONS
// =========================================================

window.addWorker = () => {
    if(currentZone === 'private') {
        if(myStats.gold >= 150) {
            myStats.gold -= 150; 
            myStats.workersCount++;
            spawnWorkerIA(); 
            socket.emit('updatePlayer', myStats);
        } else { alert("Pas assez d'or (150 requis) !"); }
    } else { alert("Tu dois √™tre dans ta zone priv√©e !"); }
};

window.buildHouse = () => {
    if(currentZone === 'private') {
        if(myStats.wood >= 50) {
            myStats.wood -= 50; 
            const p = {x: player.position.x, z: player.position.z};
            myStats.privateHouses.push(p); 
            spawnVisualHouse(p.x, p.z);
            socket.emit('updatePlayer', myStats);
        } else { alert("Pas assez de bois (50 requis) !"); }
    } else { alert("Tu dois √™tre dans ta zone priv√©e !"); }
};

// Gestion du clavier (ZQSD / WASD + E)
window.addEventListener('keydown', (e) => {
    keys[e.code] = true;

    // Touche E pour les interactions sp√©ciales
    if(e.code === 'KeyE' && currentZone === 'lobby') {
        // 1. Entrer chez soi (Distance < 15 d'une maison verte)
        const myH = lobbyHouses.find(h => h.isMine);
        if(myH && player.position.distanceTo(myH.mesh.position) < 15) {
            goPrivate();
        }
        
        // 2. Entrer dans la for√™t (Distance < 15 du centre 0,0)
        if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 15) {
            goForest();
        }
    }
});

window.addEventListener('keyup', (e) => keys[e.code] = false);

// =========================================================
//                   BOUCLE PRINCIPALE (ANIMATION)
// =========================================================
function animate() {
    requestAnimationFrame(animate);
    
    if(!player) return;

    // --- D√âPLACEMENT JOUEUR ---
    const speed = 0.8;
    if(keys['KeyW']) player.position.z -= speed;
    if(keys['KeyS']) player.position.z += speed;
    if(keys['KeyA']) player.position.x -= speed;
    if(keys['KeyD']) player.position.x += speed;

    // Cam√©ra Suiveuse
    camera.position.set(player.position.x, player.position.y + 60, player.position.z + 50);
    camera.lookAt(player.position);

    // --- LOGIQUE IA (ROBOTS) ---
    workers.forEach(w => {
        // Mise √† jour du label au dessus de la t√™te
        const sp = w.mesh.position.clone().project(camera);
        w.label.style.left = (sp.x + 1) * 50 + '%'; 
        w.label.style.top = -(sp.y - 1) * 50 + '%';
        w.label.innerText = `ü§ñ ${Math.floor(w.energy)}%`;

        if(w.state === 'find') {
            // Cherche un minerai visible
            w.target = ores.find(o => o.visible); 
            if(w.target) w.state = 'move';
        } 
        else if(w.state === 'move' && w.target) {
            // Avance vers le minerai
            if(w.mesh.position.distanceTo(w.target.position) > 2) {
                const dir = new THREE.Vector3().subVectors(w.target.position, w.mesh.position).normalize();
                w.mesh.position.add(dir.multiplyScalar(0.5)); 
                w.mesh.lookAt(w.target.position);
            } else {
                // MINE LE BLOC
                w.target.visible = false; // Disparition
                
                // Repop ailleurs
                w.target.position.set(2000+(Math.random()*400-200), 1, 2000+(Math.random()*400-200));
                setTimeout(() => w.target.visible = true, 5000);
                
                w.energy -= 10; 
                w.state = 'return';
            }
        } 
        else if(w.state === 'return') {
            // Revient vers le joueur (la base)
            if(w.mesh.position.distanceTo(player.position) > 3) {
                const dir = new THREE.Vector3().subVectors(player.position, w.mesh.position).normalize();
                w.mesh.position.add(dir.multiplyScalar(0.5)); 
                w.mesh.lookAt(player.position);
            } else {
                // D√©pose les ressources
                myStats.oreStock += 5; 
                socket.emit('updatePlayer', myStats);
                w.state = 'find'; // Repart au travail
            }
        }
    });

    // --- LOGIQUE FOR√äT (Couper du bois) ---
    if(currentZone === 'forest') {
        trees.forEach(t => { 
            if(t.visible && player.position.distanceTo(t.position) < 4) { 
                t.visible = false; // Arbre coup√©
                myStats.wood += 5; 
                socket.emit('updatePlayer', myStats); 
            }
        });
    }

    // --- LOGIQUE VENDEUR (Lobby) ---
    if(currentZone === 'lobby') {
        const vendorPos = new THREE.Vector3(-80, 0, 0);
        if(player.position.distanceTo(vendorPos) < 10) {
            if(myStats.oreStock > 0) { 
                myStats.gold += myStats.oreStock * 10; // 1 minerai = 10 Or
                myStats.oreStock = 0; 
                socket.emit('updatePlayer', myStats); 
            }
        }
    }

    // --- GESTION DE L'AFFICHAGE DU MESSAGE [E] ---
    const msg = document.getElementById('msg'); 
    msg.style.display = 'none';
    
    if(currentZone === 'lobby') {
        // Devant ma maison ?
        const myH = lobbyHouses.find(h => h.isMine);
        if(myH && player.position.distanceTo(myH.mesh.position) < 15) { 
            msg.style.display = 'block'; 
            msg.innerText = "MAISON #" + myStats.plotID + "\n[E] ENTRER CHEZ TOI"; 
        }
        // Devant le portail for√™t ?
        if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 15) { 
            msg.style.display = 'block'; 
            msg.innerText = "PORTAIL FOR√äT\n[E] T√âL√âPORTATION"; 
        }
    }

    // Mise √† jour de l'UI
    document.getElementById('gold').innerText = Math.floor(myStats.gold);
    document.getElementById('wood').innerText = Math.floor(myStats.wood);
    document.getElementById('ore').innerText = Math.floor(myStats.oreStock);

    renderer.render(scene, camera);
}
</script>
</body>
</html>
