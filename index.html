<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty : √âconomie R√©elle</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: block; }
        
        /* Interface */
        .panel { position: absolute; background: rgba(0, 10, 20, 0.9); border: 2px solid #00f2ff; padding: 15px; border-radius: 8px; pointer-events: auto; box-shadow: 0 0 15px #00f2ff44; }
        #stats { top: 10px; left: 10px; display: flex; gap: 20px; font-weight: bold; font-size: 18px; pointer-events: none; }
        #build-menu { bottom: 20px; left: 20px; width: 280px; }
        
        .btn { width: 100%; padding: 12px; margin: 5px 0; background: #001a1a; color: #00f2ff; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: #00f2ff; color: #000; }
        
        #login-screen { position: absolute; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 12px; margin: 8px; width: 260px; background: #111; border: 1px solid #00f2ff; color: white; text-align: center; border-radius: 4px; }
        
        .val { color: #00f2ff; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="letter-spacing: 10px; color: #00f2ff; text-shadow: 0 0 20px #00f2ff;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="NOM DU SOUVERAIN">
        <input type="password" id="mdp" placeholder="MOT DE PASSE">
        <button class="btn" style="width: 200px;" onclick="connect()">R√âGNER</button>
    </div>

    <div id="stats" class="panel">
        <div>‚ù§Ô∏è VIE: <span id="hp-txt" class="val">100</span></div>
        <div>üçû FAIM: <span id="food-txt" class="val">100</span></div>
        <div>üí∞ OR: <span id="gold-txt" class="val">0</span></div>
        <div>ü§ñ MINEURS: <span id="work-txt" class="val">0</span></div>
    </div>

    <div id="build-menu" class="panel">
        <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #00f2ff;">Gestion Industrielle</h3>
        <button class="btn" onclick="addWorker()">RECRUTER MINEUR (150G)</button>
        <button class="btn" onclick="buyFood()">ACHETER RATIONS (40G)</button>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"
    }
}
</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
const workers = [];
const ores = [];

// Connexion
window.connect = () => {
    const pseudo = document.getElementById('pseudo').value;
    const mdp = document.getElementById('mdp').value;
    if(pseudo && mdp) socket.emit('login', { pseudo, mdp });
};

socket.on('authSuccess', (data) => {
    myStats = data;
    document.getElementById('login-screen').style.display = 'none';
    initGame();
});

function initGame() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000205);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const amb = new THREE.AmbientLight(0xffffff, 0.4);
    const light = new THREE.PointLight(0x00f2ff, 1.5, 50);
    scene.add(amb, light);

    // Texture du sol (Grille Cyber-Herbe)
    const cv = document.createElement('canvas');
    cv.width = 256; cv.height = 256;
    const ctx = cv.getContext('2d');
    ctx.fillStyle = '#0a1a0a'; ctx.fillRect(0,0,256,256);
    ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 1;
    ctx.strokeRect(0,0,256,256);
    const groundTex = new THREE.CanvasTexture(cv);
    groundTex.wrapS = groundTex.wrapT = THREE.RepeatWrapping;
    groundTex.repeat.set(80, 80);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ map: groundTex }));
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // Joueur
    player = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshStandardMaterial({ color: 0x00f2ff }));
    player.position.y = 0.8;
    scene.add(player);

    // G√©n√©ration Minerais
    const oreGeo = new THREE.DodecahedronGeometry(0.8);
    for(let i=0; i<30; i++) {
        const ore = new THREE.Mesh(oreGeo, new THREE.MeshStandardMaterial({ color: 0x444444 }));
        ore.position.set(Math.random()*120-60, 0.4, Math.random()*120-60);
        scene.add(ore);
        ores.push(ore);
    }

    const keys = {};
    window.onkeydown = e => keys[e.code] = true;
    window.onkeyup = e => keys[e.code] = false;

    function animate() {
        requestAnimationFrame(animate);
        
        if(myStats.hp > 0) {
            const spd = 0.22;
            if(keys['KeyW']) player.position.z -= spd;
            if(keys['KeyS']) player.position.z += spd;
            if(keys['KeyA']) player.position.x -= spd;
            if(keys['KeyD']) player.position.x += spd;

            // IA MINEURS
            workers.forEach(w => {
                if(myStats.food > 0) {
                    const target = w.carrying ? player : w.targetOre;
                    const dist = w.mesh.position.distanceTo(target.position);
                    
                    if(dist > 1.5) {
                        const dir = new THREE.Vector3().subVectors(target.position, w.mesh.position).normalize();
                        w.mesh.position.add(dir.multiplyScalar(0.12));
                        w.mesh.lookAt(target.position);
                    } else {
                        if(w.carrying) {
                            myStats.gold += 35; // L'√©conomie : un voyage rapporte 35G
                            w.carrying = false;
                            w.targetOre = ores[Math.floor(Math.random()*ores.length)];
                        } else {
                            w.carrying = true;
                        }
                    }
                    w.mesh.position.y = 0.5 + Math.sin(Date.now() * 0.005) * 0.1;
                }
            });
        }

        camera.position.lerp(new THREE.Vector3(player.position.x, 15, player.position.z + 20), 0.1);
        camera.lookAt(player.position);
        light.position.copy(player.position).y = 5;
        renderer.render(scene, camera);
    }
    animate();

    // Boucle de survie & Sync
    setInterval(() => {
        if(myStats.hp > 0) {
            // Consommation : Le souverain et ses mineurs mangent
            myStats.food = Math.max(0, myStats.food - (0.5 + workers.length * 0.2));
            if(myStats.food <= 0) myStats.hp = Math.max(0, myStats.hp - 1.5);
            
            updateUI();
            socket.emit('updateStats', myStats);
        }
    }, 1000);
}

function updateUI() {
    document.getElementById('hp-txt').innerText = Math.floor(myStats.hp);
    document.getElementById('food-txt').innerText = Math.floor(myStats.food);
    document.getElementById('gold-txt').innerText = Math.floor(myStats.gold);
    document.getElementById('work-txt').innerText = workers.length;
}

window.addWorker = () => {
    if(myStats.gold >= 150) {
        myStats.gold -= 150;
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0xffff00, emissiveIntensity: 0.4 }));
        mesh.position.set(player.position.x, 0.5, player.position.z);
        scene.add(mesh);
        workers.push({ mesh, targetOre: ores[Math.floor(Math.random()*ores.length)], carrying: false });
    }
};

window.buyFood = () => {
    if(myStats.gold >= 40) {
        myStats.gold -= 40;
        myStats.food = Math.min(100, myStats.food + 50);
    }
};

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
