<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty - Plot System</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        .ui { position: absolute; inset: 0; pointer-events: none; }
        .panel { position: absolute; background: rgba(0, 10, 20, 0.9); border: 2px solid #00f2ff; padding: 15px; border-radius: 10px; color: white; pointer-events: auto; }
        #stats { top: 15px; left: 15px; display: flex; gap: 20px; font-weight: bold; font-size: 18px; }
        #menu { bottom: 20px; left: 20px; width: 300px; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #001a1a; color: #00f2ff; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; border-radius: 5px; }
        .btn:hover { background: #00f2ff; color: #000; }
        #login-screen { position: absolute; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 15px; width: 250px; background: #111; border: 1px solid #00f2ff; color: white; text-align: center; margin-bottom: 10px; }
        .label { position: absolute; color: white; font-weight: bold; font-size: 12px; pointer-events: none; text-align: center; transform: translate(-50%, -100%); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00f2ff; letter-spacing: 10px;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="NOM DU ROYAUME">
        <button class="btn" style="width: 220px;" onclick="connect()">ENTRER</button>
    </div>

    <div class="ui">
        <div id="stats" class="panel">
            <span style="color:#ffd700">üí∞ <span id="gold">0</span></span>
            <span style="color:#4dff4d">üçû <span id="food">100</span></span>
            <span style="color:#00f2ff">üì¶ <span id="ore">0</span></span>
            <span style="color:#00f2ff; margin-left:10px;">üö© PLOT: <span id="plotID">?</span></span>
        </div>
        <div id="menu" class="panel">
            <button class="btn" style="border-color:#aa00ff; color:#aa00ff;" onclick="tpToVendor()">üíú VENDEUR VIOLET</button>
            <button class="btn" onclick="buildHouse()">üè† B√ÇTIR (SUR MON PLOT)</button>
            <button class="btn" onclick="addWorker()">ü§ñ MINEUR IA</button>
            <button class="btn" style="border-color:#00ff00; color:#00ff00;" onclick="tpToLoot()">üíö ZONE DE LOOT</button>
        </div>
    </div>

    <div id="labels-container" style="position:absolute; inset:0; pointer-events:none;"></div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
const ores = [], workers = [], houses = [], plots = [], remotePlayers = {};
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const keys = {};

window.connect = () => {
    const p = document.getElementById('pseudo').value;
    if(p) socket.emit('login', { pseudo: p });
};

socket.on('initData', (data) => {
    myStats = data.me;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('plotID').innerText = myStats.plotID;
    initGame();
    data.houses.forEach(h => spawnHouseMesh(h.x, h.z));
    Object.values(data.players).forEach(p => { if(p.id !== socket.id) createRemotePlayer(p); });
});

function initGame() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 5000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.DirectionalLight(0xffffff, 0.5); sun.position.set(10, 50, 10); scene.add(sun);

    // SOL CYBER
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(4000, 4000), new THREE.MeshStandardMaterial({color: 0x050505}));
    ground.rotation.x = -Math.PI/2; scene.add(ground);
    scene.add(new THREE.GridHelper(4000, 100, 0x00f2ff, 0x001515));

    // LES 8 TERRAINS (Comme sur le dessin)
    for(let i=0; i<8; i++) {
        const x = -150 + (i % 4) * 100;
        const z = i < 4 ? -80 : 80;
        const helper = new THREE.BoxHelper(new THREE.Mesh(new THREE.BoxGeometry(80, 0.1, 80)));
        helper.position.set(x, 0, z);
        helper.material.color.set(i+1 === myStats.plotID ? 0x00ff00 : 0x333333);
        scene.add(helper);
        plots.push({ id: i+1, x, z });
    }

    // VENDEUR VIOLET (A gauche)
    const vendor = createChar(0xaa00ff); vendor.position.set(-350, 0, 0); scene.add(vendor);

    // ZONE DE LOOT (A droite)
    const lootZone = new THREE.Mesh(new THREE.CircleGeometry(30, 32), new THREE.MeshBasicMaterial({color: 0x00ff00, transparent:true, opacity:0.2}));
    lootZone.rotation.x = -Math.PI/2; lootZone.position.set(350, 0, 0); scene.add(lootZone);

    player = createChar(0x00f2ff);
    const myPlot = plots.find(p => p.id === myStats.plotID);
    player.position.set(myPlot.x, 0, myPlot.z);
    scene.add(player);

    for(let i=0; i<100; i++) spawnOre();
    animate();
}

function spawnOre() {
    const ore = new THREE.Mesh(new THREE.DodecahedronGeometry(1.5), new THREE.MeshStandardMaterial({color: 0x555}));
    ore.position.set(Math.random()*800-400, 1, Math.random()*400-200);
    scene.add(ore);
    ores.push(ore);
}

function createChar(color) {
    const g = new THREE.Group();
    const b = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.2), new THREE.MeshStandardMaterial({color}));
    b.position.y = 0.9; g.add(b);
    return g;
}

function spawnHouseMesh(x, z) {
    const b = new THREE.Mesh(new THREE.BoxGeometry(8, 6, 8), new THREE.MeshStandardMaterial({color: 0x111111}));
    b.position.set(x, 3, z);
    scene.add(b);
    houses.push({ mesh: b, label: createLabel() });
}

function createLabel() {
    const div = document.createElement('div'); div.className = 'label';
    document.getElementById('labels-container').appendChild(div);
    return div;
}

window.tpToVendor = () => player.position.set(-330, 0, 0);
window.tpToLoot = () => player.position.set(330, 0, 0);

window.buildHouse = () => {
    const myPlot = plots.find(p => p.id === myStats.plotID);
    if(player.position.distanceTo(new THREE.Vector3(myPlot.x, 0, myPlot.z)) < 40) {
        if(myStats.gold >= 100) {
            myStats.gold -= 100;
            socket.emit('newHouse', { x: player.position.x, z: player.position.z });
            socket.emit('updatePlayer', myStats);
        }
    } else { alert("Ici c'est pas chez toi !"); }
};

window.addWorker = () => {
    if(myStats.gold >= 150) {
        myStats.gold -= 150;
        const w = createChar(0xffff00); w.position.copy(player.position); scene.add(w);
        workers.push({ mesh: w, energy: 100, state: 'find', home: player.position.clone(), target: null, label: createLabel() });
        socket.emit('updatePlayer', myStats);
    }
};

window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

function animate() {
    requestAnimationFrame(animate);
    if(!player) return;

    const speed = keys['ShiftLeft'] ? 1.5 : 0.7;
    if(keys['KeyW']) player.position.z -= speed;
    if(keys['KeyS']) player.position.z += speed;
    if(keys['KeyA']) player.position.x -= speed;
    if(keys['KeyD']) player.position.x += speed;

    if(keys['KeyW'] || keys['KeyS'] || keys['KeyA'] || keys['KeyD']) {
        socket.emit('move', {x: player.position.x, z: player.position.z});
        player.lookAt(player.position.x + (keys['KeyD']?1:keys['KeyA']?-1:0), 0, player.position.z + (keys['KeyS']?1:keys['KeyW']?-1:0));
    }

    // IA MINEURS
    workers.forEach(w => {
        const p = w.mesh.position.clone().project(camera);
        w.label.style.left = (p.x+1)*50+'%'; w.label.style.top = -(p.y-1)*50+'%';
        w.label.innerText = `ü§ñ ${Math.floor(w.energy)}%`;

        if(w.state === 'find') {
            w.target = ores[Math.floor(Math.random()*ores.length)];
            w.state = 'move';
        } else if(w.state === 'move') {
            if(w.mesh.position.distanceTo(w.target.position) > 2) {
                const dir = new THREE.Vector3().subVectors(w.target.position, w.mesh.position).normalize();
                w.mesh.position.add(dir.multiplyScalar(0.6)); w.mesh.lookAt(w.target.position);
            } else {
                // ACTION : CASSE LE BLOC
                w.target.visible = false; // Dispara√Æt
                w.target.position.set(Math.random()*800-400, 1, Math.random()*400-200);
                setTimeout(() => { w.target.visible = true; }, 5000); // Repop
                w.energy -= 20; w.state = 'return';
            }
        } else if(w.state === 'return') {
            if(w.mesh.position.distanceTo(w.home) > 3) {
                const dir = new THREE.Vector3().subVectors(w.home, w.mesh.position).normalize();
                w.mesh.position.add(dir.multiplyScalar(0.6)); w.mesh.lookAt(w.home);
            } else {
                myStats.oreStock += 10; w.state = w.energy > 0 ? 'find' : 'tired';
            }
        }
    });

    // VENTE AUTO AU VENDEUR VIOLET (-350, 0, 0)
    if(player.position.distanceTo(new THREE.Vector3(-350, 0, 0)) < 15 && myStats.oreStock > 0) {
        myStats.gold += myStats.oreStock * 5; myStats.oreStock = 0;
        socket.emit('updatePlayer', myStats);
    }

    camera.position.lerp(new THREE.Vector3(player.position.x, 100, player.position.z + 80), 0.1);
    camera.lookAt(player.position);
    renderer.render(scene, camera);
    
    document.getElementById('gold').innerText = Math.floor(myStats.gold);
    document.getElementById('food').innerText = Math.floor(myStats.food);
    document.getElementById('ore').innerText = Math.floor(myStats.oreStock);
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty - Dimensions</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        .ui { position: absolute; inset: 0; pointer-events: none; }
        .panel { position: absolute; background: rgba(0,0,0,0.8); border: 2px solid #fff; padding: 15px; color: white; pointer-events: auto; border-radius: 10px; }
        #stats { top: 10px; left: 10px; display: flex; gap: 20px; border-color: #4CAF50; }
        #msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px; display: none; }
        #menu { bottom: 20px; left: 20px; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #222; color: #fff; border: 1px solid #fff; cursor: pointer; }
    </style>
</head>
<body>

    <div id="msg">APPUIE SUR [E] POUR ENTRER</div>

    <div class="ui">
        <div id="stats" class="panel">
            <span style="color:#ffd700">üí∞ <span id="gold">0</span></span>
            <span style="color:#8B4513">ü™µ <span id="wood">0</span></span>
            <span id="zone-name" style="margin-left:20px; color:#4CAF50;">LOBBY</span>
        </div>
        <div id="menu" class="panel">
            <button class="btn" onclick="buildHouse()">üè† B√ÇTIR MAISON (50 BOIS)</button>
        </div>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
let currentZone = 'lobby'; // lobby, private, forest
const keys = {}, trees = [], lobbyHouses = [];

// --- INITIALISATION ---
const pseudo = prompt("Ton Pseudo:");
if(pseudo) socket.emit('login', { pseudo });

socket.on('initData', (data) => {
    myStats = data.me;
    initScene();
});

function initScene() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const amb = new THREE.AmbientLight(0xffffff, 0.8); scene.add(amb);
    
    loadLobby();
    
    player = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1), new THREE.MeshStandardMaterial({color: 0x00ff00}));
    body.position.y = 1; player.add(body);
    scene.add(player);

    animate();
}

// --- LES ZONES ---

function loadLobby() {
    currentZone = 'lobby';
    document.getElementById('zone-name').innerText = "LOBBY";
    clearScene();
    
    // Sol Herbe
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({color: 0x2d5a27}));
    ground.rotation.x = -Math.PI/2; scene.add(ground);

    // 8 Maisons en cercle
    for(let i=0; i<8; i++) {
        const angle = (i / 8) * Math.PI * 2;
        const x = Math.cos(angle) * 40;
        const z = Math.sin(angle) * 40;
        const h = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE.MeshStandardMaterial({color: i+1 === myStats.plotID ? 0xff0000 : 0x888888}));
        h.position.set(x, 4, z);
        h.lookAt(0, 4, 0);
        scene.add(h);
        lobbyHouses.push({ mesh: h, id: i+1 });
    }

    // Zone Verte (Portail For√™t)
    const portal = new THREE.Mesh(new THREE.CircleGeometry(5, 32), new THREE.MeshBasicMaterial({color: 0x00ff00}));
    portal.position.set(0, 0.1, 0); portal.rotation.x = -Math.PI/2;
    scene.add(portal);
}

function loadPrivateZone() {
    currentZone = 'private';
    document.getElementById('zone-name').innerText = "MA ZONE PRIV√âE";
    clearScene();
    player.position.set(0,0,0);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x3d7a37}));
    ground.rotation.x = -Math.PI/2; ground.position.set(5000, 0, 5000); scene.add(ground);
    player.position.set(5000, 0, 5000);

    myStats.privateHouses.forEach(h => spawnVisualHouse(h.x, h.z));
}

function loadForest() {
    currentZone = 'forest';
    document.getElementById('zone-name').innerText = "FOR√äT (COUPER ARBRES)";
    clearScene();
    player.position.set(-5000, 0, -5000);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({color: 0x1a3317}));
    ground.rotation.x = -Math.PI/2; ground.position.set(-5000, 0, -5000); scene.add(ground);

    for(let i=0; i<50; i++) {
        const tx = -5000 + (Math.random()*300-150);
        const tz = -5000 + (Math.random()*300-150);
        spawnTree(tx, tz);
    }
}

function clearScene() {
    trees.length = 0;
    // On garde juste le player et la lumi√®re
}

// --- OBJETS ---

function spawnTree(x, z) {
    const log = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 4), new THREE.MeshStandardMaterial({color: 0x4d2600}));
    log.position.set(x, 2, z);
    const leaf = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshStandardMaterial({color: 0x00ff00}));
    leaf.position.y = 3; log.add(leaf);
    scene.add(log);
    trees.push(log);
}

function spawnVisualHouse(x, z) {
    const h = new THREE.Mesh(new THREE.BoxGeometry(8, 6, 8), new THREE.MeshStandardMaterial({color: 0xdddddd}));
    h.position.set(x, 3, z);
    scene.add(h);
}

// --- ACTIONS ---

window.buildHouse = () => {
    if(currentZone === 'private' && myStats.wood >= 50) {
        myStats.wood -= 50;
        const pos = { x: player.position.x, z: player.position.z };
        myStats.privateHouses.push(pos);
        spawnVisualHouse(pos.x, pos.z);
        socket.emit('updatePlayer', myStats);
    } else { alert("Il faut √™tre dans ta zone et avoir 50 bois !"); }
};

window.addEventListener('keydown', (e) => {
    keys[e.code] = true;
    if(e.code === 'KeyE') {
        // TP ZONE PRIV√âE
        if(currentZone === 'lobby') {
            const myHouse = lobbyHouses.find(h => h.id === myStats.plotID);
            if(player.position.distanceTo(myHouse.mesh.position) < 15) loadPrivateZone();
            else if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 10) loadForest();
        } else { loadLobby(); } // Retour au Lobby
    }
});
window.addEventListener('keyup', (e) => keys[e.code] = false);

function animate() {
    requestAnimationFrame(animate);
    
    // Deplacement
    const s = 0.8;
    if(keys['KeyW']) player.position.z -= s;
    if(keys['KeyS']) player.position.z += s;
    if(keys['KeyA']) player.position.x -= s;
    if(keys['KeyD']) player.position.x += s;

    // Interaction Arbres
    if(currentZone === 'forest') {
        trees.forEach((t, i) => {
            if(t.visible && player.position.distanceTo(t.position) < 3) {
                t.visible = false;
                myStats.wood += 10;
                socket.emit('updatePlayer', myStats);
            }
        });
    }

    // UI Feedback
    const msg = document.getElementById('msg');
    if(currentZone === 'lobby') {
        const myHouse = lobbyHouses.find(h => h.id === myStats.plotID);
        if(player.position.distanceTo(myHouse.mesh.position) < 15) {
            msg.style.display = 'block'; msg.innerText = "APPUIE SUR [E] POUR ENTRER CHEZ TOI";
        } else if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 10) {
            msg.style.display = 'block'; msg.innerText = "APPUIE SUR [E] POUR ALLER √Ä LA FOR√äT";
        } else { msg.style.display = 'none'; }
    } else { msg.style.display = 'none'; }

    camera.position.set(player.position.x, player.position.y + 60, player.position.z + 40);
    camera.lookAt(player.position);
    
    document.getElementById('gold').innerText = myStats.gold;
    document.getElementById('wood').innerText = myStats.wood;
    
    renderer.render(scene, camera);
}
</script>
</body>
</html>
