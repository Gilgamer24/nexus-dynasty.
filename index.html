<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty - Ultimate</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        .ui { position: absolute; inset: 0; pointer-events: none; }
        .panel { position: absolute; background: rgba(0,10,20,0.85); border: 2px solid #00f2ff; padding: 15px; color: white; pointer-events: auto; border-radius: 12px; backdrop-filter: blur(5px); }
        #stats { top: 10px; left: 10px; display: flex; gap: 15px; font-weight: bold; font-size: 14px; }
        #msg { position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%); color: #00f2ff; font-size: 22px; font-weight: bold; display: none; text-shadow: 0 0 10px #00f2ff; text-align: center; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #001a1a; color: #00f2ff; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; border-radius: 5px; }
        .btn:hover { background: #00f2ff; color: #000; }
        #login-screen { position: absolute; inset: 0; background: radial-gradient(circle, #001a1a 0%, #000 100%); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 15px; width: 220px; background: #111; border: 2px solid #00f2ff; color: white; text-align: center; margin-bottom: 10px; border-radius: 8px; }
        .label { position: absolute; color: #ffff00; font-weight: bold; font-size: 11px; transform: translate(-50%, -100%); pointer-events: none; text-shadow: 1px 1px #000; }
        .bar { width: 100px; height: 10px; background: #333; border: 1px solid #fff; border-radius: 5px; overflow: hidden; }
        #hunger-fill { height: 100%; background: #ffaa00; width: 100%; transition: 0.3s; }
        #hp-fill { height: 100%; background: #ff4444; width: 100%; transition: 0.3s; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00f2ff; letter-spacing: 5px;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="PSEUDO">
        <button class="btn" style="width: 150px;" onclick="connect()">ENTRER</button>
    </div>

    <div id="msg"></div>

    <div class="ui">
        <div id="stats" class="panel">
            <span>üí∞ <span id="gold">0</span></span>
            <span>ü™µ <span id="wood">0</span></span>
            <span>‚õèÔ∏è <span id="ore">0</span></span>
            <div>üçî <div class="bar"><div id="hunger-fill"></div></div></div>
            <div>‚ù§Ô∏è <div class="bar"><div id="hp-fill"></div></div></div>
        </div>
        
        <div id="menu" class="panel" style="bottom:20px; left:20px; width:260px;">
            <div id="z-name" style="color:#00f2ff; text-align:center; font-weight:bold; margin-bottom:10px;">LOBBY COMMUN</div>
            <button class="btn" onclick="buildHouse()">[1] B√ÇTIR (50 ü™µ)</button>
            <button class="btn" onclick="addWorker()">[2] ROBOT (150 üí∞)</button>
            <button class="btn" onclick="buyFood()">[3] MANGER (20 üí∞)</button>
            <button class="btn" onclick="buySword()">[4] √âP√âE LASER (200 üí∞)</button>
            <button class="btn" onclick="goLobby()" style="color:#ff4444; border-color:#ff4444; margin-top:10px;">[0] RETOUR LOBBY</button>
        </div>
    </div>
    <div id="labels-container"></div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
let currentZone = 'lobby'; 
const keys = {}, trees = [], ores = [], workers = [], visuals = [], lobbyHouses = [], enemies = [], otherPlayers = {};

window.connect = () => {
    const p = document.getElementById('pseudo').value;
    if(p) socket.emit('login', { pseudo: p });
};

socket.on('initData', (data) => {
    myStats = data.me;
    // Initialisation des nouvelles stats si manquantes
    if(!myStats.hunger) myStats.hunger = 100;
    if(!myStats.hp) myStats.hp = 100;
    if(!myStats.hasSword) myStats.hasSword = false;
    if(!myStats.plans) myStats.plans = 0;
    
    document.getElementById('login-screen').style.display = 'none';
    init();
});

// MULTIJOUEUR : Gestion des autres joueurs
socket.on('playerUpdate', (data) => {
    if(data.id === socket.id) return;
    if(!otherPlayers[data.id]) {
        otherPlayers[data.id] = createChar(0xffffff, data.pseudo);
        scene.add(otherPlayers[data.id]);
    }
    otherPlayers[data.id].position.lerp(new THREE.Vector3(data.x, 0, data.z), 0.2);
});

socket.on('playerLeft', (id) => {
    if(otherPlayers[id]) {
        scene.remove(otherPlayers[id]);
        delete otherPlayers[id];
    }
});

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 5000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 20, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040, 2));

    player = createChar(0x00f2ff, myStats.pseudo);
    scene.add(player);

    goLobby();
    animate();
}

// --- SYST√àME DE TEXTURES & VISUELS ---
function getMaterial(color, metal = 0.5) {
    return new THREE.MeshStandardMaterial({ color: color, metalness: metal, roughness: 0.4 });
}

function createChar(color, name) {
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1, 4, 8), getMaterial(color));
    body.position.y = 1;
    g.add(body);
    
    // Ajout visuel de l'√©p√©e si poss√©d√©
    if (color === 0x00f2ff && myStats && myStats.hasSword) {
        const sword = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.5, 0.1), getMaterial(0x00f2ff, 1));
        sword.position.set(0.6, 1, 0.3);
        g.add(sword);
    }
    return g;
}

function clear() {
    visuals.forEach(v => scene.remove(v));
    trees.forEach(t => scene.remove(t));
    ores.forEach(o => scene.remove(o));
    workers.forEach(w => { scene.remove(w.mesh); w.label.remove(); });
    enemies.forEach(e => scene.remove(e.mesh));
    visuals.length = 0; trees.length = 0; ores.length = 0; workers.length = 0; enemies.length = 0;
}

// --- ZONES ---
window.goLobby = () => {
    currentZone = 'lobby';
    document.getElementById('z-name').innerText = "LOBBY NEON";
    clear();
    player.position.set(0, 0, 30);
    
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), getMaterial(0x050505));
    ground.rotation.x = -Math.PI/2; scene.add(ground); visuals.push(ground);
    
    const grid = new THREE.GridHelper(500, 50, 0x00f2ff, 0x001111);
    scene.add(grid); visuals.push(grid);

    for(let i=0; i<8; i++) {
        const a = (i/8)*Math.PI*2;
        const color = (i+1 === myStats.plotID) ? 0x00ff00 : 0x222222;
        const h = new THREE.Mesh(new THREE.BoxGeometry(12, 12, 12), getMaterial(color, 0.8));
        h.position.set(Math.cos(a)*70, 6, Math.sin(a)*70);
        h.lookAt(0,6,0); scene.add(h); visuals.push(h);
        lobbyHouses[i] = { mesh: h, id: i+1 };
    }

    const port = new THREE.Mesh(new THREE.TorusGeometry(8, 0.5, 16, 32), getMaterial(0x00ff00, 1));
    port.rotation.x = Math.PI/2; port.position.y = 0.5;
    scene.add(port); visuals.push(port);
}

function goPrivate() {
    currentZone = 'private';
    document.getElementById('z-name').innerText = "VOTRE DOMAINE";
    clear();
    player.position.set(2000, 0, 2000);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), getMaterial(0x1a3310, 0));
    g.rotation.x = -Math.PI/2; g.position.set(2000, 0, 2000); scene.add(g); visuals.push(g);
    for(let i=0; i<myStats.workersCount; i++) spawnWorkerIA();
    for(let i=0; i<20; i++) spawnOre(2000 + (Math.random()*200-100), 2000 + (Math.random()*200-100));
    myStats.privateHouses.forEach(h => spawnH(h.x, h.z));
}

function goForest() {
    currentZone = 'forest';
    document.getElementById('z-name').innerText = "FOR√äT SAUVAGE";
    clear();
    player.position.set(-2000, 0, -2000);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(800, 800), getMaterial(0x0a1a05, 0));
    g.rotation.x = -Math.PI/2; g.position.set(-2000, 0, -2000); scene.add(g); visuals.push(g);
    for(let i=0; i<80; i++) spawnTree(-2000+(Math.random()*400-200), -2000+(Math.random()*400-200));
    for(let i=0; i<5; i++) spawnEnemy();
}

// --- ENTIT√âS ---
function spawnEnemy() {
    const e = createChar(0xff0000, "MONSTRE");
    e.position.set(-2000+(Math.random()*200-100), 0, -2000+(Math.random()*200-100));
    scene.add(e);
    enemies.push({ mesh: e, hp: 50 });
}

function spawnTree(x, z) {
    const t = new THREE.Group();
    const tr = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.8, 5), getMaterial(0x331a00, 0));
    tr.position.y = 2.5; t.add(tr);
    const l = new THREE.Mesh(new THREE.IcosahedronGeometry(3, 1), getMaterial(0x004400, 0));
    l.position.y = 6; t.add(l);
    t.position.set(x, 0, z); scene.add(t); trees.push(t);
}

function spawnOre(x, z) {
    const o = new THREE.Mesh(new THREE.DodecahedronGeometry(1.2), getMaterial(0x555555, 1));
    o.position.set(x, 1, z); scene.add(o); ores.push(o);
}

function spawnH(x, z) {
    const h = new THREE.Mesh(new THREE.BoxGeometry(15, 12, 15), getMaterial(0xaaaaaa, 0.5));
    h.position.set(x, 6, z); scene.add(h); visuals.push(h);
}

// --- ACTIONS CLAVIER & BOUTONS ---
window.buyFood = () => {
    if(myStats.gold >= 20) { myStats.gold -= 20; myStats.hunger = 100; updateStats(); }
}
window.buySword = () => {
    if(myStats.gold >= 200 && !myStats.hasSword) { myStats.gold -= 200; myStats.hasSword = true; alert("√âp√©e √©quip√©e !"); updateStats(); }
}
window.addWorker = () => {
    if(currentZone === 'private' && myStats.gold >= 150) { myStats.gold -= 150; myStats.workersCount++; spawnWorkerIA(); updateStats(); }
}
window.buildHouse = () => {
    if(currentZone === 'private' && myStats.wood >= 50) { 
        myStats.wood -= 50; 
        const p = {x: player.position.x, z: player.position.z};
        myStats.privateHouses.push(p); spawnH(p.x, p.z); updateStats(); 
    }
}

function updateStats() {
    document.getElementById('gold').innerText = myStats.gold;
    document.getElementById('wood').innerText = myStats.wood;
    document.getElementById('ore').innerText = myStats.oreStock;
    document.getElementById('hunger-fill').style.width = myStats.hunger + "%";
    document.getElementById('hp-fill').style.width = myStats.hp + "%";
    socket.emit('updatePlayer', myStats);
}

window.onkeydown = e => {
    keys[e.code] = true;
    // Raccourcis clavier num√©riques
    if(e.key === "1") buildHouse();
    if(e.key === "2") addWorker();
    if(e.key === "3") buyFood();
    if(e.key === "4") buySword();
    if(e.key === "0") goLobby();
    
    if(e.code === 'KeyE') {
        if(currentZone === 'lobby') {
            const myH = lobbyHouses.find(h => h && h.id === myStats.plotID);
            if(myH && player.position.distanceTo(myH.mesh.position) < 15) goPrivate();
            if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 12) goForest();
        }
    }
};
window.onkeyup = e => keys[e.code] = false;

// --- BOUCLE ANIMATION ---
let lastTime = 0;
function animate(time) {
    requestAnimationFrame(animate);
    const delta = (time - lastTime) / 1000;
    lastTime = time;

    // VITESSE R√âDUITE (0.5 au lieu de 0.9)
    const s = 0.5;
    if(keys['KeyW']) player.position.z -= s; if(keys['KeyS']) player.position.z += s;
    if(keys['KeyA']) player.position.x -= s; if(keys['KeyD']) player.position.x += s;

    // Envoi position multi
    if(time % 10 < 1) socket.emit('move', { x: player.position.x, z: player.position.z });

    // Faim progressive
    if(myStats.hunger > 0) {
        myStats.hunger -= 0.01;
    } else {
        myStats.hp -= 0.02; // Meurt de faim
    }

    // IA Robots
    workers.forEach(w => {
        if(w.state === 'find') {
            w.target = ores.find(o => o.visible); if(w.target) w.state = 'move';
        } else if(w.state === 'move' && w.target) {
            if(w.mesh.position.distanceTo(w.target.position) > 2) {
                w.mesh.position.add(new THREE.Vector3().subVectors(w.target.position, w.mesh.position).normalize().multiplyScalar(0.3));
            } else {
                w.target.visible = false; setTimeout(() => w.target.visible = true, 8000);
                w.energy -= 5; w.state = 'return';
            }
        } else if(w.state === 'return') {
            if(w.mesh.position.distanceTo(player.position) > 3) {
                w.mesh.position.add(new THREE.Vector3().subVectors(player.position, w.mesh.position).normalize().multiplyScalar(0.3));
            } else { myStats.oreStock += 5; w.state = 'find'; updateStats(); }
        }
    });

    // Ennemis (For√™t)
    enemies.forEach((e, idx) => {
        const dist = player.position.distanceTo(e.mesh.position);
        if(dist < 20) {
            e.mesh.position.add(new THREE.Vector3().subVectors(player.position, e.mesh.position).normalize().multiplyScalar(0.2));
            if(dist < 3) {
                myStats.hp -= 0.5;
                if(myStats.hasSword && keys['Space']) { // Attaque
                    e.hp -= 10;
                    if(e.hp <= 0) {
                        scene.remove(e.mesh);
                        enemies.splice(idx, 1);
                        myStats.gold += 50;
                        // CHANCE DE PLAN (COFFRE)
                        if(Math.random() < 0.2) { alert("PLAN TROUV√â !"); myStats.plans++; }
                    }
                }
            }
        }
    });

    if(currentZone === 'forest') {
        trees.forEach(t => { if(t.visible && player.position.distanceTo(t.position) < 4) { t.visible = false; myStats.wood += 5; updateStats(); }});
    }

    if(currentZone === 'lobby' && player.position.distanceTo(new THREE.Vector3(-80, 0, 0)) < 10) {
        if(myStats.oreStock > 0) { myStats.gold += myStats.oreStock * 10; myStats.oreStock = 0; updateStats(); }
    }

    const m = document.getElementById('msg'); m.style.display = 'none';
    if(currentZone === 'lobby') {
        const myH = lobbyHouses.find(h => h && h.id === myStats.plotID);
        if(myH && player.position.distanceTo(myH.mesh.position) < 15) { m.style.display = 'block'; m.innerText = "[E] ENTRER CHEZ SOI"; }
        if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 12) { m.style.display = 'block'; m.innerText = "[E] VERS LA FOR√äT"; }
    }

    camera.position.set(player.position.x, player.position.y + 60, player.position.z + 45);
    camera.lookAt(player.position);
    updateStats();
    renderer.render(scene, camera);
}
function spawnWorkerIA() {
    const w = createChar(0xffff00, "ROBOT"); w.position.copy(player.position); scene.add(w);
    const d = document.createElement('div'); d.className = 'label'; 
    document.getElementById('labels-container').appendChild(d);
    workers.push({ mesh: w, energy: 100, state: 'find', label: d });
}
</script>
</body>
</html>
