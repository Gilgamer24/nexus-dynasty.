<!DOCTYPE html>
<html>
<head>
    <title>Nexus Dynasty : Final Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* Ecran de Mort */
        #death-screen { 
            display: none; position: absolute; inset: 0; 
            background: rgba(139, 0, 0, 0.95); z-index: 9999; 
            flex-direction: column; align-items: center; justify-content: center; color: white; 
        }
        #death-screen h1 { font-size: 80px; text-shadow: 5px 5px #000; margin: 0; }

        /* Login */
        #login-screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: #111; color: #00f2ff; }
        
        /* HUD */
        .ui { position: absolute; background: rgba(0,0,0,0.85); border: 2px solid #00f2ff; border-radius: 10px; color: white; padding: 15px; pointer-events: auto; }
        #stats { top: 10px; left: 10px; display: flex; gap: 20px; font-weight: bold; font-size: 18px; }
        #nav { right: 15px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; }
        
        .btn { padding: 12px; background: #222; border: 1px solid #00f2ff; color: #00f2ff; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .btn:hover { background: #00f2ff; color: black; }
        input { padding: 10px; margin: 5px; border: 1px solid #00f2ff; background: #000; color: white; width: 250px; }
    </style>
</head>
<body>

    <div id="death-screen">
        <h1>TU ES MORT</h1>
        <p style="font-size: 20px;">Tu as perdu 40% de tes richesses...</p>
        <button class="btn" onclick="confirmRespawn()" style="font-size: 25px; padding: 20px 40px;">RENA√éTRE</button>
    </div>

    <div id="login-screen">
        <h1 style="letter-spacing: 5px;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="NOM DE SOUVERAIN">
        <input type="password" id="mdp" placeholder="MOT DE PASSE">
        <button class="btn" onclick="doLogin()">COMMENCER L'AVENTURE</button>
    </div>

    <div id="stats" class="ui">
        <div style="color: #ff4444;">‚ù§Ô∏è <span id="hp">100</span></div>
        <div style="color: #ffaa00;">üçû <span id="food">100</span></div>
        <div style="color: #ffd700;">üí∞ <span id="gold">0</span></div>
    </div>

    <div id="nav" class="ui">
        <button class="btn" onclick="changeZone('farm')">üöú FERME</button>
        <button class="btn" onclick="changeZone('adventure')">‚õèÔ∏è MINE</button>
        <button class="btn" onclick="changeZone('pvp')">‚öîÔ∏è PVP</button>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, stats, currentZone = 'farm';
const otherPlayers = {};
const blocks = [];
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.doLogin = () => {
    const pseudo = document.getElementById('pseudo').value;
    const mdp = document.getElementById('mdp').value;
    if(pseudo && mdp) socket.emit('login', { pseudo, mdp });
};

socket.on('authSuccess', (data) => {
    stats = data;
    document.getElementById('login-screen').style.display = 'none';
    initWorld();
});

function initWorld() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.PointLight(0x00f2ff, 1.5, 100);
    sun.position.set(5, 15, 5);
    scene.add(sun);

    // Sol Grid N√©on
    const grid = new THREE.GridHelper(1000, 100, 0x00f2ff, 0x111111);
    scene.add(grid);

    // Joueur (Capsule N√©on)
    player = new THREE.Mesh(
        new THREE.CapsuleGeometry(0.4, 0.8),
        new THREE.MeshStandardMaterial({color: 0x00f2ff, emissive: 0x00f2ff, emissiveIntensity: 0.5})
    );
    player.position.y = 0.8;
    scene.add(player);

    // Syst√®me de Minage (Clic)
    window.addEventListener('mousedown', (e) => {
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const hit = raycaster.intersectObjects(blocks);
        if(hit.length > 0) {
            scene.remove(hit[0].object);
            blocks.splice(blocks.indexOf(hit[0].object), 1);
            stats.gold += 15; // Or gagn√©
        }
    });

    const keys = {};
    window.onkeydown = e => keys[e.code] = true;
    window.onkeyup = e => keys[e.code] = false;

    // Game Loop
    function animate() {
        requestAnimationFrame(animate);
        if(stats.hp > 0) {
            const speed = 0.18;
            if(keys['KeyW']) player.position.z -= speed;
            if(keys['KeyS']) player.position.z += speed;
            if(keys['KeyA']) player.position.x -= speed;
            if(keys['KeyD']) player.position.x += speed;

            camera.position.lerp(new THREE.Vector3(player.position.x, 8, player.position.z + 12), 0.1);
            camera.lookAt(player.position);
            socket.emit('move', player.position);
        }
        renderer.render(scene, camera);
    }
    animate();

    // Boucle de survie (Faim/Vie)
    setInterval(() => {
        if(stats.hp > 0) {
            stats.food = Math.max(0, stats.food - 0.4);
            if(stats.food <= 0) stats.hp = Math.max(0, stats.hp - 1.5);
            
            updateUI();
            socket.emit('updateStats', stats);
            
            if(stats.hp <= 0) {
                document.getElementById('death-screen').style.display = 'flex';
            }
        }
    }, 1000);
}

function updateUI() {
    document.getElementById('hp').innerText = Math.floor(stats.hp);
    document.getElementById('food').innerText = Math.floor(stats.food);
    document.getElementById('gold').innerText = stats.gold;
}

window.changeZone = (zone) => {
    blocks.forEach(b => scene.remove(b));
    blocks.length = 0;
    if(zone === 'adventure') {
        scene.background = new THREE.Color(0x050510);
        for(let i=0; i<40; i++) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(1.5,1.5,1.5), new THREE.MeshStandardMaterial({color:0x444444}));
            b.position.set(Math.random()*80-40, 0.75, Math.random()*80-40);
            scene.add(b);
            blocks.push(b);
        }
    } else {
        scene.background = new THREE.Color(0x000000);
    }
};

window.confirmRespawn = () => {
    socket.emit('requestRespawn');
};

socket.on('respawnDone', (u) => {
    stats = u;
    player.position.set(0, 0.8, 0);
    document.getElementById('death-screen').style.display = 'none';
    updateUI();
});

socket.on('playerMoved', d => {
    if(!otherPlayers[d.id]) {
        otherPlayers[d.id] = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshBasicMaterial({color: 0xff00ff}));
        scene.add(otherPlayers[d.id]);
    }
    otherPlayers[d.id].position.copy(d.pos);
});
</script>
</body>
</html>
