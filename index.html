<!DOCTYPE html>
<html>
<head>
    <title>Nexus Dynasty : Evolution</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #auth-screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: radial-gradient(circle, #1a1a2e, #16213e); color: white; }
        .ui-panel { position: absolute; background: rgba(0,0,0,0.8); border: 2px solid #00f2ff; border-radius: 12px; padding: 15px; color: white; pointer-events: auto; }
        #nav { right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; }
        .btn-zone { width: 60px; height: 60px; cursor: pointer; border-radius: 50%; border: 2px solid #00f2ff; background: none; color: white; font-size: 24px; transition: 0.3s; }
        .btn-zone:hover { box-shadow: 0 0 20px #00f2ff; transform: scale(1.1); background: #00f2ff; color: black; }
        #hotbar { bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .slot { width: 50px; height: 50px; background: rgba(255,255,255,0.1); border: 2px solid #444; border-radius: 5px; }
        #stats { top: 20px; left: 20px; font-weight: bold; font-size: 20px; }
        input { padding: 12px; margin: 5px; width: 250px; border-radius: 8px; border: 1px solid #00f2ff; background: #000; color: #fff; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:#00f2ff; letter-spacing: 4px;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="Pseudo">
        <input type="password" id="mdp" placeholder="Mot de passe">
        <button onclick="connect()" style="margin-top:15px; padding: 10px 30px; cursor:pointer; font-weight:bold;">ENTRER DANS L'EMPIRE</button>
    </div>

    <div id="stats" class="ui-panel">üí∞ OR: <span id="gold">500</span> | üçû FAIM: <span id="food">100</span></div>

    <div id="nav" class="ui-panel">
        <button class="btn-zone" onclick="tp('farm')">üåæ</button>
        <button class="btn-zone" onclick="tp('adventure')">‚õèÔ∏è</button>
        <button class="btn-zone" onclick="tp('pvp')">‚öîÔ∏è</button>
    </div>

    <div id="hotbar" class="ui-panel">
        <div class="slot" style="background: url('https://i.imgur.com/vH0M16S.png') center/cover;"></div>
        <div class="slot"></div><div class="slot"></div><div class="slot"></div>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myData, ground;
const remotePlayers = {};

// --- TEXTURES G√âN√âR√âES ---
function createTexture(type) {
    const canvas = document.createElement('canvas');
    canvas.width = 128; canvas.height = 128;
    const ctx = canvas.getContext('2d');
    if(type === 'grass') {
        ctx.fillStyle = '#2d5a27'; ctx.fillRect(0,0,128,128);
        for(let i=0; i<100; i++) { ctx.fillStyle='#3d7a37'; ctx.fillRect(Math.random()*128, Math.random()*128, 4, 4); }
    } else {
        ctx.fillStyle = '#444'; ctx.fillRect(0,0,128,128);
        ctx.strokeStyle = '#222'; ctx.strokeRect(0,0,128,128);
    }
    const tex = new THREE.CanvasTexture(canvas);
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
    tex.repeat.set(50, 50);
    return tex;
}

window.connect = () => {
    const pseudo = document.getElementById('pseudo').value;
    const mdp = document.getElementById('mdp').value;
    if(pseudo && mdp) socket.emit('login', { pseudo, mdp });
};

socket.on('authSuccess', (data) => {
    myData = data;
    document.getElementById('auth-screen').style.display = 'none';
    init();
});

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 20, 10);
    light.castShadow = true;
    scene.add(light, new THREE.AmbientLight(0xffffff, 0.4));

    // Sol √©volutif
    ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({map: createTexture('grass')}));
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true;
    scene.add(ground);

    // Joueur HD
    player = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshStandardMaterial({color: 0x00f2ff}));
    body.position.y = 0.8; body.castShadow = true;
    player.add(body);
    scene.add(player);

    const keys = {};
    window.onkeydown = e => keys[e.code] = true;
    window.onkeyup = e => keys[e.code] = false;

    window.tp = (zone) => {
        socket.emit('teleport', zone);
        if(zone === 'adventure') {
            ground.material.map = createTexture('stone');
            scene.background = new THREE.Color(0x050510);
            // Spawn cubes
            for(let i=0; i<20; i++) {
                const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0x777}));
                b.position.set(Math.random()*40-20, 0.5, Math.random()*40-20);
                scene.add(b);
            }
        } else {
            ground.material.map = createTexture('grass');
            scene.background = new THREE.Color(0x87CEEB);
        }
    };

    function animate() {
        requestAnimationFrame(animate);
        const s = 0.15;
        if(keys['KeyW']) player.position.z -= s; if(keys['KeyS']) player.position.z += s;
        if(keys['KeyA']) player.position.x -= s; if(keys['KeyD']) player.position.x += s;
        
        camera.position.lerp(new THREE.Vector3(player.position.x, 7, player.position.z + 12), 0.1);
        camera.lookAt(player.position);
        socket.emit('move', player.position);
        renderer.render(scene, camera);
    }
    animate();
}

socket.on('pMoved', d => {
    if(!remotePlayers[d.id]) {
        remotePlayers[d.id] = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshBasicMaterial({color: 0xff00ff}));
        scene.add(remotePlayers[d.id]);
    }
    remotePlayers[d.id].position.copy(d.pos);
});
</script>
</body>
</html>
