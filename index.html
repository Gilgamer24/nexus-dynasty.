<!DOCTYPE html>
<html>
<head>
    <title>Nexus Dynasty : Industrial Era</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Verdana', sans-serif; }
        .ui { position: absolute; padding: 15px; background: rgba(0,0,0,0.8); border: 2px solid #00f2ff; border-radius: 10px; color: white; pointer-events: auto; }
        #stats { top: 10px; left: 10px; display: flex; gap: 15px; font-size: 18px; }
        #build-menu { bottom: 20px; left: 20px; width: 250px; }
        #nav { right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #111; color: #00f2ff; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #00f2ff; color: #000; }
        #login-screen { position: absolute; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 10px; margin: 5px; width: 250px; background: #111; border: 1px solid #00f2ff; color: white; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00f2ff">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="PSEUDO">
        <input type="password" id="mdp" placeholder="MOT DE PASSE">
        <button class="btn" onclick="connect()" style="width:200px">ENTRER</button>
    </div>

    <div id="stats" class="ui">
        <span style="color:#ff4444">‚ù§Ô∏è <span id="hp">100</span></span>
        <span style="color:#55ff55">üçû <span id="food">100</span></span>
        <span style="color:#ffd700">üí∞ <span id="gold">0</span></span>
        <span style="color:#00f2ff">ü§ñ MINEURS: <span id="workers">0</span></span>
    </div>

    <div id="build-menu" class="ui">
        <h3 style="margin:0 0 10px 0; color:#00f2ff">CHANTIER INDUSTRIEL</h3>
        <button class="btn" onclick="buyUnit('worker')">EMBAUCHER MINEUR (100G)</button>
        <button class="btn" onclick="buyFood()">ACHETER NOURRITURE (20G)</button>
    </div>

    <div id="nav" class="ui">
        <button class="btn" onclick="tp('farm')">üåæ FERME</button>
        <button class="btn" onclick="tp('mine')">‚õèÔ∏è MINE</button>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, userStats, ground;
const workersModels = [];

window.connect = () => {
    const pseudo = document.getElementById('pseudo').value;
    const mdp = document.getElementById('mdp').value;
    if(pseudo && mdp) socket.emit('login', { pseudo, mdp });
};

socket.on('authSuccess', (data) => {
    userStats = data.user;
    document.getElementById('login-screen').style.display = 'none';
    init();
});

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020205);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const light = new THREE.PointLight(0x00f2ff, 2, 50);
    scene.add(light);

    // Terrain textur√© (Proc√©dural)
    const canvas = document.createElement('canvas');
    canvas.width = 256; canvas.height = 256;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#111'; ctx.fillRect(0,0,256,256);
    ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 2;
    ctx.strokeRect(0,0,256,256);
    const tex = new THREE.CanvasTexture(canvas);
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
    tex.repeat.set(100, 100);

    ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({map: tex}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    player = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshStandardMaterial({color: 0x00f2ff}));
    player.position.y = 0.8;
    scene.add(player);

    const keys = {};
    window.onkeydown = e => keys[e.code] = true;
    window.onkeyup = e => keys[e.code] = false;

    function animate() {
        requestAnimationFrame(animate);
        if(userStats.hp > 0) {
            if(keys['KeyW']) player.position.z -= 0.2;
            if(keys['KeyS']) player.position.z += 0.2;
            if(keys['KeyA']) player.position.x -= 0.2;
            if(keys['KeyD']) player.position.x += 0.2;
            
            camera.position.lerp(new THREE.Vector3(player.position.x, 10, player.position.z + 15), 0.1);
            camera.lookAt(player.position);
            light.position.copy(player.position);
            light.position.y = 5;

            // Animation des mineurs
            workersModels.forEach((w, i) => {
                w.position.x += Math.sin(Date.now() * 0.001 + i) * 0.05;
                w.rotation.y += 0.05;
            });
        }
        renderer.render(scene, camera);
    }
    animate();

    // Boucle √âconomique (Toutes les secondes)
    setInterval(() => {
        if(userStats.hp > 0) {
            // Consommation nourriture (Plus de mineurs = plus de faim)
            let hunger = 0.5 + (userStats.workers * 0.2);
            userStats.food = Math.max(0, userStats.food - hunger);
            
            if(userStats.food > 0) {
                // Production d'or
                userStats.gold += (userStats.workers * 2);
            } else {
                // Si plus de nourriture, les mineurs blessent le joueur (gr√®ve !)
                userStats.hp = Math.max(0, userStats.hp - 1);
            }

            updateUI();
        }
    }, 1000);
}

function updateUI() {
    document.getElementById('hp').innerText = Math.floor(userStats.hp);
    document.getElementById('food').innerText = Math.floor(userStats.food);
    document.getElementById('gold').innerText = Math.floor(userStats.gold);
    document.getElementById('workers').innerText = userStats.workers;
}

window.buyUnit = () => {
    if(userStats.gold >= 100) {
        userStats.gold -= 100;
        userStats.workers += 1;
        const w = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({color: 0xffff00}));
        w.position.set(player.position.x + (Math.random()*4-2), 0.25, player.position.z + (Math.random()*4-2));
        scene.add(w);
        workersModels.push(w);
        socket.emit('buyWorker');
    }
};

window.buyFood = () => {
    if(userStats.gold >= 20) {
        userStats.gold -= 20;
        userStats.food = Math.min(100, userStats.food + 30);
    }
};

window.tp = (z) => {
    scene.background = (z === 'mine') ? new THREE.Color(0x050005) : new THREE.Color(0x000500);
};
</script>
</body>
</html>
