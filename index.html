<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty - Heritage</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Verdana', sans-serif; }
        .ui { position: absolute; inset: 0; pointer-events: none; }
        .panel { position: absolute; background: rgba(20, 20, 25, 0.95); border-left: 4px solid #f1c40f; padding: 15px; color: white; pointer-events: auto; }
        #stats { top: 10px; left: 10px; display: flex; flex-direction: column; gap: 8px; border-radius: 0 10px 10px 0; }
        #inv { top: 10px; right: 10px; width: 150px; text-align: right; }
        #msg { position: absolute; top: 70%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 18px; display: none; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; border: 1px solid #f1c40f; }
        .bar { width: 120px; height: 8px; background: #222; margin-top: 4px; border-radius: 4px; }
        .fill { height: 100%; border-radius: 4px; transition: 0.3s; }
        .btn { width: 100%; padding: 8px; margin: 4px 0; background: #2c3e50; color: white; border: none; cursor: pointer; font-size: 12px; }
        .btn:hover { background: #34495e; }
        #login-screen { position: absolute; inset: 0; background: #111; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#f1c40f">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="NOM DU SEIGNEUR" style="padding:10px; margin-bottom:10px;">
        <button onclick="connect()" style="padding:10px 30px; cursor:pointer;">COMMENCER</button>
    </div>

    <div id="msg"></div>

    <div class="ui">
        <div id="stats" class="panel">
            <span style="color:#f1c40f">üí∞ <span id="gold">0</span></span>
            <span style="color:#e67e22">ü™µ <span id="wood">0</span></span>
            <span style="color:#95a5a6">üß± STOCK MAISON : <span id="storage">0</span></span>
            <div>üçî FAIM <div class="bar"><div id="hunger-fill" class="fill" style="background:#27ae60"></div></div></div>
            <div>‚ù§Ô∏è VIE <div class="bar"><div id="hp-fill" class="fill" style="background:#e74c3c"></div></div></div>
        </div>

        <div id="inv" class="panel">
            <div style="font-weight:bold; color:#f1c40f; margin-bottom:5px;">INVENTAIRE</div>
            <div id="axe-txt">ü™ì Hache Lvl 1</div>
            <div id="sword-txt">‚öîÔ∏è √âp√©e Lvl 1</div>
        </div>
        
        <div id="menu" class="panel" style="bottom:20px; left:20px; width:220px;">
            <div id="loc" style="margin-bottom:10px; font-weight:bold; color:#f1c40f;">LOBBY</div>
            <button class="btn" onclick="buyHouse()">[1] ACHETER TERRAIN (500 üí∞)</button>
            <button class="btn" onclick="upgradeHouse()">[2] AM√âLIORER MAISON (1000 üí∞)</button>
            <button class="btn" onclick="buyWorker()">[3] ENGAGER MINEUR (200 üí∞)</button>
            <button class="btn" onclick="buyFood()">[4] NOURRITURE (30 üí∞)</button>
            <button class="btn" onclick="goLobby()" style="background:#c0392b;">[0] QUITTER LA ZONE</button>
        </div>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
let currentZone = 'lobby'; 
const keys = {}, trees = [], ores = [], workers = [], visuals = [], houses = [];

// --- CONNECT ---
window.connect = () => {
    const p = document.getElementById('pseudo').value;
    if(p) socket.emit('login', { pseudo: p });
};

socket.on('initData', (data) => {
    myStats = data.me;
    document.getElementById('login-screen').style.display = 'none';
    init();
});

// --- INITIALISATION ---
function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020205);
    camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 2000);
    
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(50, 100, 50);
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));

    player = createHero(0x3498db);
    scene.add(player);

    goLobby();
    animate();
}

// --- VISUELS AM√âLIOR√âS ---
function createHero(color) {
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.8, 0.6), new THREE.MeshStandardMaterial({color}));
    body.position.y = 0.9;
    g.add(body);
    // T√™te
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), new THREE.MeshStandardMaterial({color: 0xffdbac}));
    head.position.y = 2.1;
    g.add(head);
    return g;
}

function spawnHouse(x, z, ownerName, level) {
    const h = new THREE.Group();
    // Base pierre
    const base = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE.MeshStandardMaterial({color: 0x7f8c8d}));
    base.position.y = 4; h.add(base);
    // Toit bois
    const roof = new THREE.Mesh(new THREE.ConeGeometry(8, 6, 4), new THREE.MeshStandardMaterial({color: 0x4e342e}));
    roof.position.y = 11; roof.rotation.y = Math.PI/4; h.add(roof);
    
    h.position.set(x, 0, z);
    scene.add(h);
    houses.push({ mesh: h, owner: ownerName, lvl: level });
}

// --- LOGIQUE ZONES ---
window.goLobby = () => {
    currentZone = 'lobby'; document.getElementById('loc').innerText = "LOBBY";
    clearScene();
    player.position.set(0, 0, 40);
    // Sol pav√©
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({color: 0x1a1a1a}));
    ground.rotation.x = -Math.PI/2; scene.add(ground); visuals.push(ground);
    
    // Vendeur d'armes (Remplace l'acheteur de pierre)
    const blacksmith = createHero(0xe74c3c);
    blacksmith.position.set(-30, 0, -20);
    scene.add(blacksmith); visuals.push(blacksmith);

    // Portail For√™t
    const p = new THREE.Mesh(new THREE.TorusGeometry(5, 0.4, 16, 32), new THREE.MeshBasicMaterial({color: 0x27ae60}));
    p.position.set(0, 5, -50); scene.add(p); visuals.push(p);
}

function goPrivate() {
    currentZone = 'private'; document.getElementById('loc').innerText = "VOTRE TERRE";
    clearScene();
    player.position.set(1000, 0, 1000);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x145a32}));
    g.rotation.x = -Math.PI/2; g.position.set(1000, 0, 1000); scene.add(g); visuals.push(g);
    
    // Si la maison est construite
    if(myStats.house.built) {
        spawnHouse(1000, 1000, myStats.pseudo, myStats.house.lvl);
        // Spawn des mineurs
        for(let i=0; i<myStats.house.workers; i++) spawnMiner(1000, 1000);
    }
    // Minerais
    for(let i=0; i<15; i++) spawnOre(1000+(Math.random()*100-50), 1000+(Math.random()*100-50));
}

function goForest() {
    currentZone = 'forest'; document.getElementById('loc').innerText = "FOR√äT PROFONDE";
    clearScene();
    player.position.set(-1000, 0, -1000);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x0a2f1a}));
    g.rotation.x = -Math.PI/2; g.position.set(-1000, 0, -1000); scene.add(g); visuals.push(g);
    
    for(let i=0; i<40; i++) spawnTree(-1000+(Math.random()*200-100), -1000+(Math.random()*200-100));
}

// --- ENTIT√âS ---
function spawnTree(x, z) {
    const t = new THREE.Group();
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.7, 5), new THREE.MeshStandardMaterial({color: 0x5d4037}));
    trunk.position.y = 2.5; t.add(trunk);
    const leaves = new THREE.Mesh(new THREE.SphereGeometry(3), new THREE.MeshStandardMaterial({color: 0x1b5e20}));
    leaves.position.y = 6; t.add(leaves);
    t.position.set(x, 0, z);
    t.userData = { hp: 5 }; // IL FAUT 5 COUPS
    scene.add(t); trees.push(t);
}

function spawnOre(x, z) {
    const o = new THREE.Mesh(new THREE.DodecahedronGeometry(1), new THREE.MeshStandardMaterial({color: 0x7f8c8d, metalness: 0.9}));
    o.position.set(x, 0.5, z);
    scene.add(o); ores.push(o);
}

function spawnMiner(hx, hz) {
    const m = createHero(0xf1c40f);
    m.scale.set(0.7, 0.7, 0.7);
    m.position.set(hx, 0, hz);
    scene.add(m);
    workers.push({ mesh: m, state: 'mine', target: null, housePos: new THREE.Vector3(hx, 0, hz) });
}

function clearScene() {
    visuals.forEach(v => scene.remove(v)); trees.forEach(t => scene.remove(t));
    ores.forEach(o => scene.remove(o)); workers.forEach(w => scene.remove(w.mesh));
    houses.forEach(h => scene.remove(h.mesh));
    visuals.length = 0; trees.length = 0; ores.length = 0; workers.length = 0; houses.length = 0;
}

// --- ACTIONS ---
window.buyHouse = () => {
    if(myStats.gold >= 500 && !myStats.house.built) {
        myStats.gold -= 500; myStats.house.built = true; 
        myStats.house.x = 1000; myStats.house.z = 1000;
        goPrivate(); updateStats();
    }
};

window.buyFood = () => {
    if(myStats.gold >= 30) { 
        myStats.gold -= 30; 
        myStats.hunger = Math.min(100, myStats.hunger + 40);
        myStats.hp = Math.min(100, myStats.hp + 10);
        updateStats(); 
    }
};

window.buyWorker = () => {
    const max = myStats.house.lvl * 5;
    if(myStats.gold >= 200 && myStats.house.workers < max) {
        myStats.gold -= 200; myStats.house.workers++;
        spawnMiner(1000, 1000); updateStats();
    } else { alert("Max mineurs atteint ou pas d'or !"); }
};

function updateStats() {
    document.getElementById('gold').innerText = myStats.gold;
    document.getElementById('wood').innerText = myStats.wood;
    document.getElementById('storage').innerText = myStats.house.storage;
    document.getElementById('hunger-fill').style.width = myStats.hunger + "%";
    document.getElementById('hp-fill').style.width = myStats.hp + "%";
    socket.emit('updatePlayer', myStats);
}

// --- BOUCLE ---
function animate() {
    requestAnimationFrame(animate);
    
    // D√©placement lent
    const s = 0.4;
    if(keys['KeyW']) player.position.z -= s; if(keys['KeyS']) player.position.z += s;
    if(keys['KeyA']) player.position.x -= s; if(keys['KeyD']) player.position.x += s;

    // Faim
    myStats.hunger -= 0.005;
    if(myStats.hunger <= 0) { myStats.hunger = 0; myStats.hp -= 0.01; }

    // Mineurs : Ram√®nent √† la maison
    workers.forEach(w => {
        if(w.state === 'mine') {
            w.target = ores[0]; // Simple logic
            if(w.target) {
                w.mesh.position.lerp(w.target.position, 0.02);
                if(w.mesh.position.distanceTo(w.target.position) < 1) w.state = 'return';
            }
        } else {
            w.mesh.position.lerp(w.housePos, 0.02);
            if(w.mesh.position.distanceTo(w.housePos) < 1) {
                myStats.house.storage += 1;
                myStats.gold += 5; // La maison g√©n√®re du profit
                w.state = 'mine';
            }
        }
    });

    // Interaction Arbres (Plusieurs coups)
    if(currentZone === 'forest' && keys['Space']) {
        trees.forEach(t => {
            if(t.visible && player.position.distanceTo(t.position) < 4) {
                t.userData.hp -= 0.1; // Il faut rester appuy√© ou cliquer souvent
                if(t.userData.hp <= 0) { t.visible = false; myStats.wood += 10; updateStats(); }
            }
        });
    }

    // Changement de zones
    if(currentZone === 'lobby') {
        if(player.position.distanceTo(new THREE.Vector3(0,0,-50)) < 8) goForest();
        if(player.position.distanceTo(new THREE.Vector3(-30,0,-20)) < 8) {
             // Shop d'armes (Exemple : upgrade hache)
             if(myStats.gold >= 500) { myStats.gold -= 500; myStats.axeLvl++; updateStats(); alert("Hache am√©lior√©e !"); }
        }
    }
    
    // Message contextuel [E]
    const msg = document.getElementById('msg'); msg.style.display = 'none';
    if(currentZone === 'lobby' && player.position.z > 20) { msg.style.display='block'; msg.innerText="[E] ALLER SUR SON TERRAIN"; }

    camera.position.set(player.position.x, player.position.y + 40, player.position.z + 30);
    camera.lookAt(player.position);
    updateStats();
    renderer.render(scene, camera);
}

window.onkeydown = e => {
    keys[e.code] = true;
    if(e.code === 'KeyE' && currentZone === 'lobby') goPrivate();
    if(e.key === '1') buyHouse();
    if(e.key === '2') upgradeHouse();
    if(e.key === '3') buyWorker();
    if(e.key === '4') buyFood();
    if(e.key === '0') goLobby();
};
window.onkeyup = e => keys[e.code] = false;
</script>
</body>
</html>
