<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Dynasty - Render Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        .ui { position: absolute; inset: 0; pointer-events: none; }
        .panel { position: absolute; background: rgba(0,10,20,0.9); border: 2px solid #00f2ff; padding: 15px; color: white; pointer-events: auto; border-radius: 8px; }
        #stats { top: 10px; left: 10px; display: flex; gap: 20px; font-weight: bold; }
        #msg { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); color: #00f2ff; font-size: 24px; font-weight: bold; display: none; text-shadow: 0 0 10px #00f2ff; text-align: center; background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #00f2ff; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #001a1a; color: #00f2ff; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #00f2ff; color: #000; }
        #login-screen { position: absolute; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 15px; width: 200px; background: #111; border: 2px solid #00f2ff; color: white; text-align: center; margin-bottom: 10px; }
        .label { position: absolute; color: #ffff00; font-weight: bold; font-size: 12px; transform: translate(-50%, -100%); pointer-events: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00f2ff">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="PSEUDO">
        <button class="btn" style="width: 150px;" onclick="connect()">JOUER</button>
    </div>

    <div id="msg"></div>

    <div class="ui">
        <div id="stats" class="panel">
            <span>üí∞ <span id="gold">0</span></span>
            <span>ü™µ <span id="wood">0</span></span>
            <span>‚õèÔ∏è <span id="ore">0</span></span>
        </div>
        <div id="menu" class="panel" style="bottom:20px; left:20px; width:250px;">
            <div id="z-name" style="color:#00f2ff; text-align:center; font-weight:bold; margin-bottom:10px;">LOBBY</div>
            <button class="btn" onclick="buildHouse()">üè† B√ÇTIR (50 BOIS)</button>
            <button class="btn" onclick="addWorker()">ü§ñ ROBOT (150G)</button>
            <button class="btn" onclick="goLobby()" style="color:red; border-color:red;">üö™ LOBBY</button>
        </div>
    </div>
    <div id="labels-container" style="position:absolute; inset:0; pointer-events:none;"></div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, myStats;
let currentZone = 'lobby'; 
const keys = {}, trees = [], ores = [], workers = [], visuals = [], lobbyHouses = [];

window.connect = () => {
    const p = document.getElementById('pseudo').value;
    if(p) socket.emit('login', { pseudo: p });
};

socket.on('initData', (data) => {
    myStats = data.me;
    document.getElementById('login-screen').style.display = 'none';
    init();
});

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 5000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 1));
    player = createChar(0x00f2ff);
    scene.add(player);

    goLobby();
    animate();
}

function clear() {
    visuals.forEach(v => scene.remove(v));
    trees.forEach(t => scene.remove(t));
    ores.forEach(o => scene.remove(o));
    workers.forEach(w => { scene.remove(w.mesh); w.label.remove(); });
    visuals.length = 0; trees.length = 0; ores.length = 0; workers.length = 0;
}

window.goLobby = () => {
    currentZone = 'lobby';
    document.getElementById('z-name').innerText = "LOBBY";
    clear();
    player.position.set(0, 0, 30);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({color: 0x111}));
    g.rotation.x = -Math.PI/2; scene.add(g); visuals.push(g);
    scene.add(new THREE.GridHelper(400, 40, 0x00f2ff, 0x002222));

    for(let i=0; i<8; i++) {
        const a = (i/8)*Math.PI*2;
        const color = (i+1 === myStats.plotID) ? 0x00ff00 : 0x444;
        const h = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE// Portail (Cercle vert au milieu du Lobby)
    const port = new THREE.Mesh(new THREE.CircleGeometry(10, 32), new THREE.MeshBasicMaterial({color: 0x00ff00, transparent: true, opacity: 0.4}));
    port.rotation.x = -Math.PI/2; port.position.y = 0.1;
    scene.add(port); visuals.push(port);
    
    const v = createChar(0xaa00ff); v.position.set(-80, 0, 0); // Vendeur Violet
    scene.add(v); visuals.push(v);
}

function goPrivate() {
    currentZone = 'private';
    document.getElementById('z-name').innerText = "ZONE HERBE";
    clear();
    player.position.set(2000, 0, 2000);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(800, 800), new THREE.MeshStandardMaterial({color: 0x2d5a27}));
    g.rotation.x = -Math.PI/2; g.position.set(2000, 0, 2000); scene.add(g); visuals.push(g);
    for(let i=0; i<myStats.workersCount; i++) spawnWorkerIA();
    for(let i=0; i<30; i++) spawnOre(2000 + (Math.random()*200-100), 2000 + (Math.random()*200-100));
    myStats.privateHouses.forEach(h => spawnH(h.x, h.z));
}

function goForest() {
    currentZone = 'forest';
    document.getElementById('z-name').innerText = "FOR√äT";
    clear();
    player.position.set(-2000, 0, -2000);
    const g = new THREE.Mesh(new THREE.PlaneGeometry(600, 600), new THREE.MeshStandardMaterial({color: 0x1a3317}));
    g.rotation.x = -Math.PI/2; g.position.set(-2000, 0, -2000); scene.add(g); visuals.push(g);
    for(let i=0; i<60; i++) spawnTree(-2000+(Math.random()*300-150), -2000+(Math.random()*300-150));
}

function spawnTree(x, z) {
    const t = new THREE.Group();
    const tr = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 4), new THREE.MeshStandardMaterial({color: 0x4d2600}));
    tr.position.y = 2; t.add(tr);
    const l = new THREE.Mesh(new THREE.SphereGeometry(2.5), new THREE.MeshStandardMaterial({color: 0x228B22}));
    l.position.y = 5; t.add(l);
    t.position.set(x, 0, z); scene.add(t); trees.push(t);
}

function spawnOre(x, z) {
    const o = new THREE.Mesh(new THREE.IcosahedronGeometry(1.2), new THREE.MeshStandardMaterial({color: 0x777}));
    o.position.set(x, 1, z); scene.add(o); ores.push(o);
}

function spawnWorkerIA() {
    const w = createChar(0xffff00); w.position.copy(player.position); scene.add(w);
    const d = document.createElement('div'); d.className = 'label'; 
    document.getElementById('labels-container').appendChild(d);
    workers.push({ mesh: w, energy: 100, state: 'find', home: player.position.clone(), target: null, label: d });
}

function spawnH(x, z) {
    const h = new THREE.Mesh(new THREE.BoxGeometry(12, 10, 12), new THREE.MeshStandardMaterial({color: 0xeee}));
    h.position.set(x, 5, z); scene.add(h); visuals.push(h);
}

window.buildHouse = () => {
    if(currentZone === 'private' && myStats.wood >= 50) {
        myStats.wood -= 50; const p = {x: player.position.x, z: player.position.z};
        myStats.privateHouses.push(p); spawnH(p.x, p.z); socket.emit('updatePlayer', myStats);
    }
};

window.addWorker = () => {
    if(currentZone === 'private' && myStats.gold >= 150) {
        myStats.gold -= 150; myStats.workersCount++; spawnWorkerIA(); socket.emit('updatePlayer', myStats);
    }
};

function createChar(color) {
    const g = new THREE.Group();
    const b = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.2), new THREE.MeshStandardMaterial({color}));
    b.position.y = 1; g.add(b); return g;
}

window.onkeydown = e => {
    keys[e.code] = true;
    if(e.code === 'KeyE' && currentZone === 'lobby') {
        const myH = lobbyHouses.find(h => h.id === myStats.plotID);
        if(player.position.distanceTo(myH.mesh.position) < 15) goPrivate();
        if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 12) goForest();
    }
};
window.onkeyup = e => keys[e.code] = false;

function animate() {
    requestAnimationFrame(animate);
    const s = 0.9;
    if(keys['KeyW']) player.position.z -= s; if(keys['KeyS']) player.position.z += s;
    if(keys['KeyA']) player.position.x -= s; if(keys['KeyD']) player.position.x += s;

    workers.forEach(w => {
        const p = w.mesh.position.clone().project(camera);
        w.label.style.left = (p.x + 1) * 50 + '%'; w.label.style.top = -(p.y - 1) * 50 + '%';
        w.label.innerText = `ü§ñ ${Math.floor(w.energy)}%`;
        if(w.state === 'find') {
            w.target = ores.find(o => o.visible); if(w.target) w.state = 'move';
        } else if(w.state === 'move' && w.target) {
            if(w.mesh.position.distanceTo(w.target.position) > 2) {
                w.mesh.position.add(new THREE.Vector3().subVectors(w.target.position, w.mesh.position).normalize().multiplyScalar(0.5));
            } else {
                w.target.visible = false; setTimeout(() => w.target.visible = true, 5000);
                w.energy -= 10; w.state = 'return';
            }
        } else if(w.state === 'return') {
            if(w.mesh.position.distanceTo(player.position) > 3) {
                w.mesh.position.add(new THREE.Vector3().subVectors(player.position, w.mesh.position).normalize().multiplyScalar(0.5));
            } else { myStats.oreStock += 5; w.state = 'find'; }
        }
    });

    if(currentZone === 'forest') {
        trees.forEach(t => { if(t.visible && player.position.distanceTo(t.position) < 4) { t.visible = false; myStats.wood += 5; socket.emit('updatePlayer', myStats); }});
    }

    if(currentZone === 'lobby' && player.position.distanceTo(new THREE.Vector3(-80, 0, 0)) < 10 && myStats.oreStock > 0) {
        myStats.gold += myStats.oreStock * 10; myStats.oreStock = 0; socket.emit('updatePlayer', myStats);
    }

    const m = document.getElementById('msg'); m.style.display = 'none';
    if(currentZone === 'lobby') {
        const myH = lobbyHouses.find(h => h.id === myStats.plotID);
        if(player.position.distanceTo(myH.mesh.position) < 15) { m.style.display = 'block'; m.innerText = "[E] TA ZONE"; }
        if(player.position.distanceTo(new THREE.Vector3(0,0,0)) < 12) { m.style.display = 'block'; m.innerText = "[E] FOR√äT"; }
    }

    camera.position.set(player.position.x, player.position.y + 60, player.position.z + 45);
    camera.lookAt(player.position);
    document.getElementById('gold').innerText = Math.floor(myStats.gold);
    document.getElementById('wood').innerText = Math.floor(myStats.wood);
    document.getElementById('ore').innerText = Math.floor(myStats.oreStock);
    renderer.render(scene, camera);
}
</script>
</body>
</html>
