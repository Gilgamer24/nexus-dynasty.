<!DOCTYPE html>
<html>
<head>
    <title>Nexus Dynasty : Adventure</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Menus */
        .panel { position: absolute; background: rgba(0, 10, 20, 0.9); border: 2px solid #00f2ff; color: #fff; padding: 15px; pointer-events: auto; border-radius: 10px; }
        #stats-panel { top: 10px; left: 10px; width: 200px; }
        #build-panel { bottom: 10px; left: 10px; width: 220px; }
        #help-panel { top: 10px; right: 10px; width: 250px; font-size: 13px; }
        
        /* Barres de vie/faim */
        .bar-bg { width: 100%; height: 12px; background: #222; margin: 5px 0; border-radius: 6px; overflow: hidden; border: 1px solid #444; }
        #hp-bar { width: 100%; height: 100%; background: #ff4444; transition: 0.3s; }
        #food-bar { width: 100%; height: 100%; background: #ffaa00; transition: 0.3s; }

        .btn { width: 100%; padding: 8px; margin: 4px 0; background: #004466; color: white; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #00f2ff; color: #000; }
        
        #zone-tag { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

<div id="ui-overlay">
    <div id="stats-panel" class="panel">
        <b id="display-pseudo">Chargement...</b>
        <div>‚ù§Ô∏è Vie</div><div class="bar-bg"><div id="hp-bar"></div></div>
        <div>üçû Faim</div><div class="bar-bg"><div id="food-bar"></div></div>
        <div style="color: #ffd700; margin-top: 5px;">üí∞ Or: <span id="gold-val">0</span></div>
    </div>

    <div id="help-panel" class="panel">
        <b>GUIDE DE SURVIE</b><hr>
        ‚Ä¢ <b>Centre (Vert) :</b> Zone de Paix (Construction).<br>
        ‚Ä¢ <b>Ext√©rieur (Gris) :</b> Zone d'Aventure (Faim acc√©l√©r√©e).<br>
        ‚Ä¢ <b>Action :</b> Cliquez sur le sol pour diriger la cam√©ra.
    </div>

    <div id="build-panel" class="panel">
        <b>üèóÔ∏è CONSTRUCTIONS</b>
        <button class="btn" onclick="orderBuild('farm')">FERME (50G)</button>
        <button class="btn" onclick="orderBuild('mine')">MINE (80G)</button>
        <button class="btn" style="background:#446600" onclick="sellFood()">VENDRE NOURRITURE</button>
    </div>

    <div id="zone-tag">ZONE DE PAIX</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

// --- INITIALISATION & SAUVEGARDE ---
let pseudo = localStorage.getItem('nexus_pseudo') || prompt("Ton Pseudo ?", "Voyageur");
localStorage.setItem('nexus_pseudo', pseudo);
let savedGold = parseInt(localStorage.getItem('nexus_gold')) || 100;

const socket = io();
socket.emit('join', { pseudo: pseudo, gold: savedGold });

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(10, 20, 10);
scene.add(sun, new THREE.AmbientLight(0xffffff, 0.6));

// --- TERRAIN ---
// Centre vert (Safe), Ext√©rieur gris (Aventure)
const groundGeo = new THREE.PlaneGeometry(1000, 1000);
const groundMat = new THREE.MeshStandardMaterial({ color: 0x333333 }); // D√©faut Aventure
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

const safeZone = new THREE.Mesh(
    new THREE.CircleGeometry(40, 32),
    new THREE.MeshStandardMaterial({ color: 0x44aa44 })
);
safeZone.rotation.x = -Math.PI/2;
safeZone.position.y = 0.01;
scene.add(safeZone);

// --- MOD√àLES ---
function createCharModel(color, isBuilder = false) {
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshStandardMaterial({color: isBuilder ? 0xffff00 : color}));
    body.position.y = 0.6;
    g.add(body);
    return g;
}

function createBuilding(type) {
    const g = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({color: type === 'farm' ? 0x8B4513 : 0x555555});
    const base = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 2), mat);
    base.position.y = 0.75;
    g.add(base);
    return g;
}

// --- LOGIQUE JEU ---
let myId = "";
const players = {};
let myStats = { hp: 100, food: 100, gold: savedGold };
const keys = {};

socket.on('init', d => { 
    myId = d.id; 
    document.getElementById('display-pseudo').innerText = d.pseudo;
});

socket.on('currentPlayers', data => {
    Object.keys(data).forEach(id => {
        if(!players[id]) {
            players[id] = createCharModel(data[id].color);
            scene.add(players[id]);
        }
    });
});

socket.on('playerMoved', d => { if(players[d.id]) players[d.id].position.set(d.x, d.y, d.z); });

// --- BOUCLE DE SURVIE ---
setInterval(() => {
    if(!myId) return;
    const dist = players[myId].position.length();
    const isSafe = dist < 40;
    
    document.getElementById('zone-tag').innerText = isSafe ? "ZONE DE PAIX" : "ZONE D'AVENTURE";
    document.getElementById('zone-tag').style.color = isSafe ? "#00ff00" : "#ff4444";

    myStats.food -= isSafe ? 0.2 : 1.5;
    if(myStats.food <= 0) { myStats.food = 0; myStats.hp -= 2; }
    
    document.getElementById('hp-bar').style.width = myStats.hp + "%";
    document.getElementById('food-bar').style.width = myStats.food + "%";
    document.getElementById('gold-val').innerText = myStats.gold;
    localStorage.setItem('nexus_gold', myStats.gold);

    if(myStats.hp <= 0) { alert("Game Over !"); myStats.hp = 100; players[myId].position.set(0,0,0); }
}, 1000);

// --- CONSTRUCTION & ACTIONS ---
window.orderBuild = (type) => {
    const cost = type === 'farm' ? 50 : 80;
    if(myStats.gold < cost) return alert("Pas assez d'or !");
    
    myStats.gold -= cost;
    const builder = createCharModel(0, true);
    builder.position.copy(players[myId].position);
    scene.add(builder);
    
    const target = players[myId].position.clone().add(new THREE.Vector3(3, 0, 3));
    
    // Animation simple constructeur
    let step = 0;
    const interval = setInterval(() => {
        builder.position.lerp(target, 0.1);
        step++;
        if(step > 30) {
            clearInterval(interval);
            const b = createBuilding(type);
            b.position.copy(target);
            scene.add(b);
            scene.remove(builder);
            if(type === 'farm') setInterval(() => { myStats.food = Math.min(100, myStats.food + 5); }, 5000);
        }
    }, 100);
};

window.sellFood = () => {
    if(myStats.food > 50) {
        myStats.food -= 30;
        myStats.gold += 20;
    } else { alert("Pas assez de nourriture √† vendre !"); }
};

// --- CONTROLES ---
let yaw = 0;
renderer.domElement.onclick = () => renderer.domElement.requestPointerLock();
document.onmousemove = e => { if(document.pointerLockElement) yaw -= e.movementX * 0.003; };
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

function animate() {
    requestAnimationFrame(animate);
    if(players[myId]) {
        const me = players[myId];
        const move = new THREE.Vector3();
        if(keys['KeyW']) move.z -= 0.15;
        if(keys['KeyS']) move.z += 0.15;
        if(keys['KeyA']) move.x -= 0.15;
        if(keys['KeyD']) move.x += 0.15;
        
        move.applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
        me.position.add(move);
        
        camera.position.copy(me.position).add(new THREE.Vector3(0, 5, 10).applyAxisAngle(new THREE.Vector3(0,1,0), yaw));
        camera.lookAt(me.position);
        socket.emit('playerMovement', { x: me.position.x, y: me.position.y, z: me.position.z });
    }
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
