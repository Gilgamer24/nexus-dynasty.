<!DOCTYPE html>
<html>
<head>
    <title>Nexus Dynasty : Industrial AI</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; inset: 0; pointer-events: none; color: white; }
        .panel { position: absolute; background: rgba(0,0,0,0.85); border: 2px solid #00f2ff; padding: 15px; border-radius: 10px; pointer-events: auto; }
        
        /* Barre de Stats */
        #stats { top: 10px; left: 10px; display: flex; gap: 20px; font-weight: bold; font-size: 18px; box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        
        /* Menu Action */
        #menu { bottom: 20px; left: 20px; width: 280px; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; background: #111; color: #00f2ff; border: 1px solid #00f2ff; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:hover { background: #00f2ff; color: #000; box-shadow: 0 0 10px #00f2ff; }

        /* Login */
        #login-screen { position: absolute; inset: 0; background: radial-gradient(circle, #001a1a, #000); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 12px; margin: 5px; width: 250px; background: #111; border: 1px solid #00f2ff; color: white; text-align: center; }
        
        .red { color: #ff4444; }
        .green { color: #55ff55; }
        .gold { color: #ffd700; }
        .cyan { color: #00f2ff; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00f2ff; letter-spacing:8px; text-shadow: 0 0 10px #00f2ff;">NEXUS DYNASTY</h1>
        <input type="text" id="pseudo" placeholder="PSEUDO">
        <input type="password" id="mdp" placeholder="MOT DE PASSE">
        <button class="btn" onclick="connect()" style="width:200px">REJOINDRE</button>
    </div>

    <div id="ui">
        <div id="stats" class="panel">
            <span class="red">‚ù§Ô∏è <span id="hp">100</span></span>
            <span class="green">üçû <span id="food">100</span></span>
            <span class="gold">üí∞ <span id="gold">0</span></span>
            <span class="cyan">ü§ñ <span id="work-count">0</span></span>
        </div>

        <div id="menu" class="panel">
            <button class="btn" onclick="addWorker()">EMBAUCHER MINEUR (100G)</button>
            <button class="btn" onclick="buyFood()">RAVITAILLEMENT (30G)</button>
        </div>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js"}}</script>

<script type="module">
import * as THREE from 'three';

const socket = io();
let scene, camera, renderer, player, stats;
const workers = [];
const ores = [];

window.connect = () => {
    const pseudo = document.getElementById('pseudo').value;
    const mdp = document.getElementById('mdp').value;
    if(pseudo && mdp) socket.emit('login', { pseudo, mdp });
};

socket.on('authSuccess', (data) => {
    stats = data;
    document.getElementById('login-screen').style.display = 'none';
    init();
});

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lumi√®res
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.DirectionalLight(0xffffff, 1);
    sun.position.set(10, 20, 10);
    scene.add(sun);

    // --- TEXTURE DE SOL HAUTE QUALIT√â ---
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 512;
    const ctx = canvas.getContext('2d');
    
    // Fond vert sombre
    ctx.fillStyle = '#122412'; ctx.fillRect(0,0,512,512); 
    
    // Grille Cyber
    ctx.strokeStyle = 'rgba(0, 242, 255, 0.2)';
    ctx.lineWidth = 2;
    ctx.strokeRect(0,0,512,512);
    
    // D√©tails d'herbe
    for(let i=0; i<1500; i++) {
        ctx.fillStyle = `rgba(0, ${Math.random()*100+40}, 20, 0.4)`;
        ctx.fillRect(Math.random()*512, Math.random()*512, 3, 3);
    }
    
    const tex = new THREE.CanvasTexture(canvas);
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
    tex.repeat.set(60, 60);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1200, 1200), new THREE.MeshStandardMaterial({map: tex}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Joueur (Capsule Cyan)
    player = new THREE.Mesh(
        new THREE.CapsuleGeometry(0.4, 0.8), 
        new THREE.MeshStandardMaterial({color: 0x00f2ff, emissive: 0x00f2ff, emissiveIntensity: 0.3})
    );
    player.position.y = 0.8;
    scene.add(player);

    // Cr√©ation des Minerais (Cibles des mineurs)
    const oreGeo = new THREE.IcosahedronGeometry(1, 0);
    const oreMat = new THREE.MeshStandardMaterial({color: 0x333333, roughness: 0.8});
    for(let i=0; i<20; i++) {
        const ore = new THREE.Mesh(oreGeo, oreMat);
        ore.position.set(Math.random()*100-50, 0.5, Math.random()*100-50);
        scene.add(ore);
        ores.push(ore);
    }

    const keys = {};
    window.onkeydown = e => keys[e.code] = true;
    window.onkeyup = e => keys[e.code] = false;

    function animate() {
        requestAnimationFrame(animate);
        
        if(stats.hp > 0) {
            // D√©placement Joueur
            const s = 0.25;
            if(keys['KeyW']) player.position.z -= s;
            if(keys['KeyS']) player.position.z += s;
            if(keys['KeyA']) player.position.x -= s;
            if(keys['KeyD']) player.position.x += s;

            // --- IA DES MINEURS ---
            workers.forEach(w => {
                if (stats.food > 0) {
                    // Si plein d'or -> va vers le joueur. Si vide -> va vers le minerai.
                    const target = w.carrying ? player : w.targetOre;
                    const dist = w.mesh.position.distanceTo(target.position);
                    
                    if (dist > 1.8) {
                        const dir = new THREE.Vector3().subVectors(target.position, w.mesh.position).normalize();
                        w.mesh.position.add(dir.multiplyScalar(0.12)); // Vitesse mineur
                        w.mesh.lookAt(target.position);
                    } else {
                        // Contact !
                        if (w.carrying) {
                            stats.gold += 25; // Gain d'or
                            w.carrying = false;
                            // Change de cible pour le prochain tour
                            w.targetOre = ores[Math.floor(Math.random()*ores.length)];
                        } else {
                            w.carrying = true; // A min√© le rocher
                        }
                    }
                    // Animation de flottement
                    w.mesh.position.y = 0.5 + Math.sin(Date.now() * 0.005) * 0.2;
                }
            });
        }

        camera.position.lerp(new THREE.Vector3(player.position.x, 15, player.position.z + 20), 0.1);
        camera.lookAt(player.position);
        renderer.render(scene, camera);
    }
    animate();

    // Boucle de survie
    setInterval(() => {
        if(stats.hp > 0) {
            // Plus de mineurs = plus de consommation de nourriture
            stats.food = Math.max(0, stats.food - (0.4 + workers.length * 0.15));
            
            // Si famine, la vie baisse
            if(stats.food <= 0) stats.hp = Math.max(0, stats.hp - 2);
            
            updateUI();
            socket.emit('updateStats', stats);
        }
    }, 1000);
}

window.addWorker = () => {
    if(stats.gold >= 100) {
        stats.gold -= 100;
        const mesh = new THREE.Mesh(
            new THREE.BoxGeometry(0.6, 0.6, 0.6), 
            new THREE.MeshStandardMaterial({color: 0xffff00, emissive: 0xffff00, emissiveIntensity: 0.5})
        );
        mesh.position.set(player.position.x, 0.5, player.position.z);
        scene.add(mesh);
        
        workers.push({
            mesh: mesh,
            targetOre: ores[Math.floor(Math.random()*ores.length)],
            carrying: false
        });
        updateUI();
    }
};

window.buyFood = () => {
    if(stats.gold >= 30) {
        stats.gold -= 30;
        stats.food = Math.min(100, stats.food + 50);
        updateUI();
    }
};

function updateUI() {
    document.getElementById('hp').innerText = Math.floor(stats.hp);
    document.getElementById('food').innerText = Math.floor(stats.food);
    document.getElementById('gold').innerText = stats.gold;
    document.getElementById('work-count').innerText = workers.length;
}
</script>
</body>
</html>
